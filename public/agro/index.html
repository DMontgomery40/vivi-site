<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGRO — Another Good RAG Option</title>
    <link rel="stylesheet" href="/gui/css/tokens.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--fg);
            line-height: 1.6;
        }

        .topbar {
            background: var(--panel);
            border-bottom: 1px solid var(--line);
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar h1 {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 20px;
        }

        .topbar .brand {
            font-weight: 800;
            color: var(--accent);
            font-size: 28px;
            letter-spacing: 0.5px;
        }

        .topbar .tagline {
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--fg-muted);
            opacity: 0.6;
        }

        .top-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .top-actions button {
            background: var(--accent);
            color: var(--accent-contrast);
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            transition: all 0.2s;
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }

        .top-actions button:hover { filter: brightness(0.95); }
        .top-actions button:active { transform: scale(0.98); }

        #health-status {
            color: var(--fg-muted);
            font-size: 13px;
            font-family: 'SF Mono', monospace;
            min-width: 60px;
        }

        #global-search {
            width: 320px;
            height: 38px;
            background: var(--input-bg);
            color: var(--fg);
            border: 1px solid var(--line);
            padding: 0 14px;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            transition: all 0.2s ease;
        }

        #global-search:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--ring); }

        #global-search::placeholder {
            color: var(--fg-muted);
            font-size: 13px;
        }

        #search-results {
            position: absolute;
            top: 46px;
            right: 80px;
            width: 480px;
            max-height: 420px;
            overflow-y: auto;
            overflow-x: hidden;
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 10px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }

        #search-results .item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--line);
            transition: all 0.15s ease;
        }

        #search-results .item:last-child {
            border-bottom: none;
        }

        #search-results .item:hover, #search-results .item.active { background: var(--bg-elev2); }

        #search-results .item-label {
            display: block;
            color: var(--fg);
            font-size: 14px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            margin-bottom: 4px;
        }

        #search-results .item-context {
            display: block;
            color: var(--fg-muted);
            font-size: 12px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        #search-results .search-highlight { background: var(--accent); color: var(--accent-contrast);
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        mark.hl { background: var(--accent); color: var(--accent-contrast);
            padding: 1px 3px;
            border-radius: 2px;
        }

        .search-hit {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            border-radius: 4px;
            transition: outline 120ms ease;
        }

        :root {
            --sidepanel-width: 400px;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr var(--sidepanel-width);
            height: calc(100vh - 65px);
            position: relative;
        }

        .content {
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--line);
            overflow: visible;
        }

        .resize-handle {
            position: absolute;
            left: calc(100% - var(--sidepanel-width) - 3px);
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            z-index: 100;
            transition: background 0.2s ease;
        }

        .resize-handle:hover, .resize-handle.dragging { background: var(--ring); }

        .resize-handle::after {
            content: '';
            position: absolute;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 40px;
            background: var(--line);
            border-radius: 2px;
            transition: background 0.2s ease;
        }

        .resize-handle:hover::after,
        .resize-handle.dragging::after {
            background: var(--accent);
        }

        .tab-bar {
            background: var(--panel);
            padding: 10px 16px;
            border-bottom: 1px solid var(--line);
            display: flex;
            gap: 6px;
            overflow-x: auto;
            position: sticky;
            top: 56px;
            z-index: 99;
        }

        .tab-bar::-webkit-scrollbar {
            height: 4px;
        }

        .tab-bar::-webkit-scrollbar-thumb {
            background: var(--bg-elev2);
            border-radius: 2px;
        }

        .tab-bar button {
            background: var(--bg-elev2);
            color: var(--fg-muted);
            border: 1px solid var(--line);
            padding: 9px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.15s;
            min-height: 44px;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }

        .tab-bar button:hover { filter: brightness(1.05); color: var(--fg); border-color: var(--line); }

        .tab-bar button.active {
            background: var(--accent);
            color: var(--accent-contrast);
            border-color: var(--accent);
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 24px;
            overflow-y: visible;
            flex: 1;
        }

        .tab-content.active {
            display: block;
        }

        .subtab-bar {
            background: var(--bg-elev2);
            padding: 8px 16px;
            border-bottom: 1px solid var(--line);
            display: flex;
            gap: 4px;
            position: sticky;
            top: 56px;
            z-index: 98;
        }

        .subtab-btn {
            background: transparent;
            color: var(--fg-muted);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .subtab-btn:hover {
            background: var(--bg-elev1);
            color: var(--fg);
        }

        .subtab-btn.active {
            background: var(--accent);
            color: var(--accent-contrast);
            font-weight: 600;
        }

        #calc-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: var(--card-bg);
        }

        .settings-section {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--line);
            color: var(--fg);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-section h3 span {
            font-size: 10px;
        }

        .settings-section p.small {
            margin-bottom: 14px;
            line-height: 1.5;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            min-width: 0; /* prevent grid overflow in narrow sidepanel */
        }

        .input-group.full-width {
            grid-column: span 2;
        }

        label {
            font-size: 12px;
            color: var(--fg-muted);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 7px;
            font-weight: 500;
        }

        input, select, textarea {
            background: var(--input-bg);
            border: 1px solid var(--line);
            color: var(--fg);
            padding: 9px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'SF Mono', 'Monaco', monospace;
            transition: all 0.2s;
        }

        input[type="number"], input[type="text"] {
            max-width: 100%;
        }

        /* Fix for datalist inputs to prevent jankiness */
        input[list] {
            padding-right: 30px; /* Space for dropdown arrow */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Style the datalist dropdown arrow */
        input[list]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
            filter: invert(1);
        }

        input[list]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--ring); }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-size: 13px;
            line-height: 1.5;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .action-buttons button {
            background: var(--accent);
            color: var(--accent-contrast);
            border: none;
            padding: 11px 22px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.15s;
            box-shadow: 0 2px 8px var(--ring);
        }

        .action-buttons button:hover {
            filter: brightness(0.96);
            box-shadow: 0 4px 12px var(--ring);
            transform: translateY(-1px);
        }

        .action-buttons button:active {
            transform: translateY(0);
        }

        .sidepanel {
            background: var(--card-bg);
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        #profile-tooltip {
            position: fixed;
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 12px 16px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            z-index: 10000;
            display: none;
            pointer-events: none;
        }

        #profile-tooltip .tooltip-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--line);
        }

        #profile-tooltip .tooltip-item {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 6px 0;
            border-bottom: 1px solid var(--line);
            font-size: 12px;
        }

        #profile-tooltip .tooltip-item:last-child {
            border-bottom: none;
        }

        #profile-tooltip .tooltip-key {
            color: var(--fg-muted);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            flex-shrink: 0;
        }

        #profile-tooltip .tooltip-value {
            color: var(--fg);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            text-align: right;
            word-break: break-all;
        }

        /* Ensure sidepanel two-column rows never overflow */
        .sidepanel .input-row {
            grid-template-columns: 1fr 1fr;
            gap: 12px; /* Ensure spacing between columns */
        }
        .sidepanel .input-group {
            min-width: 0; /* Allow flex items to shrink */
        }
        .sidepanel .input-group input,
        .sidepanel .input-group select,
        .sidepanel .input-group textarea {
            width: 100%;
            min-width: 0;
            box-sizing: border-box; /* Include padding in width calculation */
        }

        .sidepanel-section {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .sidepanel-section h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 14px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Collapsible sections */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .collapsible-header:hover { color: var(--accent); }

        .collapse-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.3s ease;
            color: var(--accent);
            font-size: 12px;
        }

        .collapsible-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .sidepanel-section h4::before {
            content: '▸';
            font-size: 12px;
            color: var(--fg-muted);
        }

        .cost-results {
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 4px;
            padding: 12px;
            margin-top: 12px;
        }

        .cost-results .result-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--line);
        }

        .cost-results .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-size: 12px;
            color: var(--fg-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .result-value {
            font-size: 14px;
            color: var(--accent);
            font-weight: 600;
            font-family: 'SF Mono', monospace;
        }

        .progress {
            position: relative;
            overflow: hidden;
        }

        .progress div {
            box-shadow: 0 0 10px rgba(255, 155, 94, 0.3);
        }

        .dropzone {
            border: 2px dashed var(--accent);
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            color: var(--fg-muted);
            line-height: 1.6;
        }

        .dropzone:hover {
            background: var(--code-bg);
            color: var(--accent);
            border-color: var(--accent);
        }

        .dropzone:active {
            background: var(--panel-bg);
        }

        .mono {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 13px;
            color: var(--fg-muted);
            line-height: 1.5;
        }

        .result-display {
            background: var(--code-bg);
            border: 1px solid var(--line);
            border-radius: 6px;
            padding: 14px;
            margin-top: 12px;
            font-family: 'SF Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--fg);
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: none;
        }

        .result-display .key {
            color: var(--link);
            font-weight: 600;
        }

        .result-display .value { color: var(--fg); }

        .result-display .section {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--line);
        }

        .result-display .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .small-button {
            background: var(--bg-elev2);
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 7px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            transition: all 0.2s;
            width: 100%;
            margin-top: 8px;
        }

        .small-button:hover {
            background: var(--accent);
            color: var(--accent-contrast);
        }

        /* Tooltips (inline to guarantee availability) */
        .tooltip-wrap { position: relative; display: inline-block; }
        .help-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 14px; height: 14px; margin-left: 6px; border-radius: 50%;
            background: var(--bg-elev2); color: var(--link); font-size: 10px; line-height: 14px;
            cursor: help; border: 1px solid var(--line); user-select: none; font-weight: 700;
        }
        .help-icon:hover { background: var(--accent); color: var(--accent-contrast); border-color: var(--accent); }
        .tooltip-bubble {
            position: absolute; z-index: 1000; top: 22px; left: 0; min-width: 260px; max-width: 460px;
            padding: 8px 12px; background: var(--card-bg); color: var(--fg); border: 1px solid var(--line); border-radius: 6px;
            font-size: 12px; line-height: 1.45; box-shadow: 0 6px 18px rgba(0,0,0,0.45);
            display: none;
        }
        .tooltip-bubble .tt-title { font-weight: 700; color: var(--fg); display:block; margin-bottom: 6px; }
        .tooltip-bubble .tt-links { margin-top: 8px; opacity: 0.9; }
        .tooltip-bubble .tt-links a { color: var(--link); text-decoration: none; margin-right: 10px; }
        .tooltip-bubble .tt-links a:hover { text-decoration: underline; }
        .tooltip-visible { display: block !important; }
        .tooltip-bubble .tt-badges { margin: 6px 0 4px 0; display:flex; gap:6px; flex-wrap:wrap; }
        .tooltip-bubble .tt-badge { font-size: 10px; text-transform: uppercase; letter-spacing: .4px; padding: 2px 6px; border-radius: 4px; border: 1px solid var(--line); color: var(--fg-muted); background: var(--bg-elev2); }
        .tooltip-bubble .tt-badge.warn { color: var(--warn); border-color: var(--line); background: var(--bg-elev1); }
        .tooltip-bubble .tt-badge.info { color: var(--link); border-color: var(--line); background: var(--bg-elev1); }
        .tooltip-bubble .tt-badge.reindex { color: var(--accent); border-color: var(--line); background: var(--bg-elev1); }

        /* Keyword Manager - Custom select styling */
        select[id^="kw-all-"],
        select[id^="kw-repo-"] {
            background: var(--input-bg);
            border: 1px solid var(--line);
            border-radius: 6px;
            padding: 8px;
            font-size: 13px;
            color: var(--fg);
            font-family: 'SF Mono', 'Monaco', monospace;
            scrollbar-width: thin;
            scrollbar-color: var(--line) var(--input-bg);
        }

        select[id^="kw-all-"]::-webkit-scrollbar,
        select[id^="kw-repo-"]::-webkit-scrollbar {
            width: 8px;
        }

        select[id^="kw-all-"]::-webkit-scrollbar-track,
        select[id^="kw-repo-"]::-webkit-scrollbar-track {
            background: var(--input-bg);
            border-radius: 4px;
        }

        select[id^="kw-all-"]::-webkit-scrollbar-thumb,
        select[id^="kw-repo-"]::-webkit-scrollbar-thumb {
            background: var(--bg-elev2);
            border-radius: 4px;
            border: 2px solid var(--input-bg);
        }

        select[id^="kw-all-"]::-webkit-scrollbar-thumb:hover,
        select[id^="kw-repo-"]::-webkit-scrollbar-thumb:hover {
            background: var(--bg-elev2);
        }

        select[id^="kw-all-"] option,
        select[id^="kw-repo-"] option {
            padding: 6px 8px;
            background: var(--input-bg);
            color: var(--fg);
        }

        select[id^="kw-all-"] option:checked,
        select[id^="kw-repo-"] option:checked {
            background: var(--accent);
            color: var(--accent-contrast);
            font-weight: 600;
        }

        select[id^="kw-all-"]:focus,
        select[id^="kw-repo-"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--ring);
        }

        /* History dropdown styles */
        #history-dropdown button:hover { background: var(--bg-elev1) !important; }

        #history-dropdown button:active {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* History button active state */
        #chat-history:hover { background: var(--bg-elev2) !important; }
    </style>
    <link rel="stylesheet" href="/gui/css/storage-calculator.css">
    <style>
        .dash-two {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        /* Color accents for different types of info */
        .accent-blue { color: var(--link); }
        .accent-purple { color: var(--link); }
        .accent-orange { color: var(--warn); }
        .accent-cyan { color: var(--link); }
        .accent-pink { color: var(--link); }

        .settings-section.wizard {
            border-left: 3px solid var(--link);
        }

        .settings-section.cost {
            border-left: 3px solid var(--link);
        }

        .settings-section.indexing {
            border-left: 3px solid var(--warn);
        }

        .settings-section.overview {
            border-left: 3px solid var(--link);
        }

        /* Live indicator animation */
        @keyframes blink {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 6px var(--accent);
            }
            50% {
                opacity: 0.3;
                box-shadow: 0 0 0 var(--accent);
            }
        }

        @media (max-width: 1200px) {
            .layout {
                grid-template-columns: 1fr;
            }
            .sidepanel {
                border-top: 1px solid var(--line);
            }
            .dash-two {
                grid-template-columns: 1fr;
            }
        }

        /* ===================================
           TABLET RESPONSIVE (768px - 1024px)
           PRIMARY FOCUS - Most Used
           =================================== */
        @media (max-width: 1024px) {
            :root {
                --sidepanel-width: 350px;
            }

            /* More compact topbar */
            .topbar {
                padding: 12px 16px;
                height: 52px;
            }

            .topbar .brand {
                font-size: 24px;
            }

            .topbar .tagline {
                font-size: 10px;
                letter-spacing: 2px;
            }

            /* Adjust top actions */
            .top-actions {
                gap: 8px;
            }

            #global-search {
                width: 240px;
                height: 36px;
                font-size: 13px;
            }

            .top-actions button {
                padding: 7px 12px;
                font-size: 12px;
            }

            /* Tab bar optimization */
            .tab-bar {
                padding: 8px 12px;
                gap: 4px;
            }

            .tab-bar button {
                padding: 8px 14px;
                font-size: 12px;
            }

            /* Settings sections: maintain readability */
            .settings-section {
                padding: 16px;
                margin-bottom: 16px;
            }

            .settings-section h3 {
                font-size: 15px;
                margin-bottom: 14px;
            }

            /* Input rows: keep 2-column on landscape tablet */
            .input-row {
                gap: 12px;
            }

            /* Sidepanel adjustments */
            .sidepanel {
                padding: 16px;
            }

            /* Action buttons grid: adapt to tablet */
            .action-buttons {
                flex-wrap: wrap;
            }

            /* Reduce spacing overall */
            .tab-content {
                padding: 16px;
            }
        }

        /* ===================================
           MOBILE & SMALL TABLET (<768px)
           =================================== */
        @media (max-width: 768px) {
            /* Hide regular tab bar, show hamburger */
            .tab-bar {
                display: none;
            }

            /* Hamburger menu button */
            .mobile-nav-toggle {
                display: flex !important;
            }

            /* Adjust topbar for mobile */
            .topbar {
                padding: 10px 12px;
                height: auto;
                flex-wrap: wrap;
                gap: 8px;
            }

            .topbar h1 {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                flex: 1;
            }

            .topbar .brand {
                font-size: 20px;
            }

            .topbar .tagline {
                font-size: 9px;
                letter-spacing: 1.5px;
                opacity: 0.7;
            }

            /* Top actions: stack or wrap */
            .top-actions {
                flex-wrap: wrap;
                width: 100%;
                gap: 6px;
            }

            #global-search {
                width: 100%;
                order: 10;
            }

            #search-results {
                right: 12px;
                left: 12px;
                width: auto;
            }

            /* Layout: full single column */
            .layout {
                height: auto;
                min-height: calc(100vh - 80px);
            }

            .content {
                border-right: none;
            }

            /* Sidepanel: stacked below */
            .sidepanel {
                border-top: 1px solid var(--line);
                max-height: 60vh;
            }

            .resize-handle {
                display: none;
            }

            /* Tab content: reduced padding */
            .tab-content {
                padding: 12px;
            }

            /* Settings sections: single column */
            .settings-section {
                padding: 14px;
                margin-bottom: 14px;
            }

            .settings-section h3 {
                font-size: 14px;
                margin-bottom: 12px;
            }

            /* Input rows: SINGLE COLUMN on mobile */
            .input-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .input-group.full-width {
                grid-column: span 1;
            }

            /* Dash two: single column */
            .dash-two {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            /* Action buttons: stack */
            .action-buttons {
                flex-direction: column;
            }

            .action-buttons button {
                width: 100%;
            }

            /* Small buttons: full width */
            .small-button {
                width: 100%;
                padding: 10px;
            }

            /* Sidepanel sections: compact */
            .sidepanel-section {
                padding: 12px;
                margin-bottom: 12px;
            }

            .sidepanel-section h4 {
                font-size: 13px;
            }

            /* Onboarding: single column */
            .ob-container {
                grid-template-columns: 1fr;
                padding: 20px 12px;
                gap: 20px;
            }

            .ob-choice-cards {
                grid-template-columns: 1fr;
            }

            .ob-help-panel {
                position: static;
            }
        }

        /* ===================================
           PHONE PORTRAIT (<480px)
           =================================== */
        @media (max-width: 480px) {
            .topbar {
                padding: 8px 10px;
            }

            .topbar .brand {
                font-size: 18px;
            }

            .topbar .tagline {
                display: none;
            }

            .top-actions button {
                padding: 6px 10px;
                font-size: 11px;
                min-height: 40px;
            }

            #health-status {
                display: none;
            }

            .tab-content {
                padding: 10px;
            }

            .settings-section {
                padding: 12px;
            }

            /* Tighter input spacing */
            input, select, textarea {
                padding: 8px 10px;
                font-size: 13px;
            }

            label {
                font-size: 11px;
            }

            /* Card builder modal: full width on tiny screens */
            #cards-builder-modal {
                width: calc(100vw - 20px);
            }
        }

        /* ===================================
           HAMBURGER MENU STYLES
           =================================== */
        .mobile-nav-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 6px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            transition: all 0.2s;
        }

        .mobile-nav-toggle:active {
            transform: scale(0.95);
        }

        .mobile-nav-toggle svg {
            width: 24px;
            height: 24px;
            stroke: var(--fg);
            transition: transform 0.3s ease;
        }

        .mobile-nav-toggle.active svg {
            transform: rotate(90deg);
        }

        .mobile-nav-drawer {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            height: 100vh;
            background: var(--panel);
            border-right: 1px solid var(--line);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding: 20px 0;
            box-shadow: 4px 0 12px rgba(0,0,0,0.3);
        }

        .mobile-nav-drawer.active {
            left: 0;
        }

        .mobile-nav-drawer .nav-header {
            padding: 0 20px 16px;
            border-bottom: 1px solid var(--line);
            margin-bottom: 16px;
        }

        .mobile-nav-drawer .nav-header h2 {
            margin: 0;
            font-size: 20px;
            color: var(--accent);
        }

        .mobile-nav-drawer button {
            display: block;
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            padding: 14px 20px;
            color: var(--fg-muted);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .mobile-nav-drawer button:active {
            background: var(--bg-elev1);
        }

        .mobile-nav-drawer button.active {
            background: var(--bg-elev2);
            color: var(--accent);
            border-left-color: var(--accent);
            font-weight: 600;
        }

        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.6);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .mobile-nav-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Action Button Styles */
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 12px;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 8px;
            color: var(--fg-muted);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .action-btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(0, 255, 136, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .action-btn:hover {
            background: var(--panel);
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.2);
        }

        .action-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 6px rgba(0, 255, 136, 0.3);
        }

        .action-btn:active:before {
            width: 300px;
            height: 300px;
        }

        .action-btn svg {
            transition: all 0.2s;
        }

        .action-btn:hover svg {
            stroke: var(--accent);
            filter: drop-shadow(0 0 4px rgba(0, 255, 136, 0.5));
        }

        .action-btn.loading {
            pointer-events: none;
            opacity: 0.6;
        }

        .action-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        .action-btn.success {
            background: color-mix(in oklch, var(--ok) 8%, var(--bg));
            border-color: var(--accent);
            color: var(--accent);
        }

        .action-btn.success svg {
            stroke: var(--accent);
        }

        .action-btn.error {
            background: color-mix(in oklch, var(--warn) 8%, var(--bg));
            border-color: var(--err);
            color: var(--err);
        }

        .action-btn.error svg {
            stroke: var(--err);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ============================================
           Onboarding Wizard Styles
           All using CSS tokens for light/dark themes
           ============================================ */

        .ob-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 40px;
            align-items: start;
        }

        .ob-progress-dots {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
        }

        .ob-dot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--panel-bg);
            border: 2px solid var(--line);
            color: var(--fg-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .ob-dot.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
            box-shadow: 0 0 12px var(--accent);
        }

        .ob-step {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .ob-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ob-main {
            background: var(--panel-bg);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 40px;
        }

        .ob-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--fg);
            margin: 0 0 12px 0;
        }

        .ob-subtitle {
            font-size: 16px;
            color: var(--fg-muted);
            margin: 0 0 30px 0;
            line-height: 1.5;
        }

        .ob-info-box {
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-left: 3px solid var(--accent);
            border-radius: 8px;
            padding: 16px 20px;
            margin: 20px 0;
        }

        .ob-info-box p {
            margin: 8px 0;
            font-size: 14px;
            color: var(--fg-muted);
            line-height: 1.6;
        }

        .ob-warning-box {
            background: var(--card-bg);
            border: 1px solid var(--err);
            border-left: 3px solid var(--err);
            border-radius: 8px;
            padding: 16px 20px;
            margin: 20px 0;
            color: var(--err);
            font-size: 14px;
        }

        .ob-tooltip-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .ob-choice-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .ob-card {
            background: var(--card-bg);
            border: 2px solid var(--line);
            border-radius: 12px;
            padding: 32px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .ob-card:hover {
            border-color: var(--accent);
            background: var(--panel-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.1);
        }

        .ob-card svg {
            margin-bottom: 16px;
            stroke: var(--accent);
        }

        .ob-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--fg);
            margin: 0 0 8px 0;
        }

        .ob-card p {
            font-size: 14px;
            color: var(--fg-muted);
            margin: 0;
        }

        .ob-links {
            margin-top: 30px;
        }

        .ob-links h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--fg-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 0 12px 0;
        }

        .ob-link-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .ob-link-grid a {
            font-size: 13px;
            color: var(--link);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .ob-link-grid a:hover {
            background: var(--card-bg);
            border-color: var(--line);
        }

        .ob-mode-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .ob-mode-tab {
            flex: 1;
            padding: 12px 20px;
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--fg-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ob-mode-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }

        .ob-mode-content {
            display: none;
        }

        .ob-mode-content.active {
            display: block;
        }

        .ob-input-group {
            margin-bottom: 24px;
        }

        .ob-input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--fg);
            margin-bottom: 8px;
        }

        .ob-text-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--input-bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            color: var(--fg);
            font-size: 14px;
            font-family: inherit;
        }

        .ob-text-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        .ob-hint {
            font-size: 12px;
            color: var(--fg-muted);
            margin: 8px 0;
        }

        .ob-file-input {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .ob-browse-btn {
            padding: 10px 20px;
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 6px;
            color: var(--fg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ob-browse-btn:hover {
            background: var(--panel-bg);
            border-color: var(--accent);
        }

        .ob-file-display {
            font-size: 14px;
            color: var(--fg-muted);
        }

        .ob-stages {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin: 30px 0;
        }

        .ob-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .ob-stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--line);
            transition: all 0.3s ease;
        }

        .ob-stage.active .ob-stage-dot {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }

        .ob-stage span {
            font-size: 12px;
            color: var(--fg-muted);
            text-align: center;
        }

        .ob-stage.active span {
            color: var(--accent);
            font-weight: 600;
        }

        .ob-stage-arrow {
            color: var(--line);
            font-size: 20px;
        }

        .ob-progress-bar {
            height: 8px;
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }

        .ob-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--link) 100%);
            transition: width 0.5s ease;
        }

        .ob-progress-text {
            font-size: 14px;
            color: var(--fg-muted);
            text-align: center;
            margin-top: 8px;
        }

        .ob-log {
            background: var(--code-bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 12px;
            color: var(--fg-muted);
            line-height: 1.6;
        }

        .ob-questions-list {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin: 30px 0;
        }

        .ob-question-item {
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 20px;
        }

        .ob-question-input {
            width: calc(100% - 100px);
            padding: 12px 16px;
            background: var(--input-bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            color: var(--fg);
            font-size: 14px;
            font-family: inherit;
            margin-right: 12px;
        }

        .ob-ask-btn {
            padding: 12px 24px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: var(--bg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ob-ask-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .ob-answer {
            margin-top: 16px;
            padding: 16px;
            background: var(--panel-bg);
            border-left: 3px solid var(--accent);
            border-radius: 6px;
            font-size: 14px;
            color: var(--fg);
            line-height: 1.6;
            display: none;
        }

        .ob-answer.visible {
            display: block;
        }

        .ob-trace-link {
            display: inline-block;
            margin-top: 12px;
            font-size: 13px;
            color: var(--link);
            text-decoration: none;
        }

        .ob-trace-link:hover {
            text-decoration: underline;
        }

        .ob-trace-panel {
            margin-top: 12px;
            padding: 16px;
            background: var(--code-bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 12px;
            color: var(--fg-muted);
            max-height: 300px;
            overflow-y: auto;
        }

        .ob-sliders {
            display: flex;
            flex-direction: column;
            gap: 32px;
            margin: 30px 0;
        }

        .ob-slider-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--fg);
            margin-bottom: 12px;
        }

        .ob-slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            background: var(--line);
            border-radius: 6px;
            outline: none;
            -webkit-appearance: none;
        }

        .ob-slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .ob-slider-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .ob-slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }

        .ob-slider-labels span {
            font-size: 12px;
            color: var(--fg-muted);
        }

        .ob-settings-box {
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
        }

        .ob-settings-box h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--fg);
            margin: 0 0 12px 0;
        }

        .ob-summary-content {
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 13px;
            color: var(--fg-muted);
            line-height: 1.8;
        }

        .ob-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .ob-primary-btn {
            flex: 1;
            padding: 16px 32px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: var(--bg);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ob-primary-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        .ob-secondary-btn {
            padding: 14px 28px;
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 10px;
            color: var(--fg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ob-secondary-btn:hover {
            background: var(--panel-bg);
            border-color: var(--accent);
        }

        .ob-eval-box {
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .ob-eval-result {
            margin-top: 16px;
            padding: 16px;
            background: var(--panel-bg);
            border-left: 3px solid var(--accent);
            border-radius: 6px;
            font-size: 14px;
            color: var(--fg);
        }

        .ob-help-panel {
            background: var(--panel-bg);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 24px;
            position: sticky;
            top: 20px;
        }

        .ob-help-panel h4 {
            font-size: 16px;
            font-weight: 700;
            color: var(--fg);
            margin: 0 0 8px 0;
        }

        .ob-help-panel p {
            font-size: 13px;
            color: var(--fg-muted);
            margin: 0 0 16px 0;
        }

        .ob-help-input {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            color: var(--fg);
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 12px;
        }

        .ob-help-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .ob-help-btn {
            width: 100%;
            padding: 10px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: var(--bg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ob-help-btn:hover {
            opacity: 0.9;
        }

        .ob-help-results {
            margin-top: 16px;
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 8px;
            font-size: 13px;
            color: var(--fg);
            line-height: 1.6;
            display: none;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            max-width: 100%;
            overflow-x: auto;
        }

        .ob-help-results.visible {
            display: block;
        }

        .ob-help-pills {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }

        .ob-help-pill {
            padding: 8px 12px;
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 6px;
            color: var(--fg-muted);
            font-size: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ob-help-pill:hover {
            background: var(--panel-bg);
            border-color: var(--accent);
            color: var(--accent);
        }

        .ob-help-link {
            display: inline-block;
            margin-top: 16px;
            font-size: 13px;
            color: var(--link);
            text-decoration: none;
        }

        .ob-help-link:hover {
            text-decoration: underline;
        }

        .ob-footer {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--line);
        }

        .ob-nav-btn {
            padding: 12px 32px;
            background: var(--card-bg);
            border: 1px solid var(--line);
            border-radius: 10px;
            color: var(--fg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ob-nav-btn:hover {
            background: var(--panel-bg);
            border-color: var(--accent);
        }

        .ob-nav-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }

        .ob-nav-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .ob-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ob-nav-btn:disabled:hover {
            transform: none;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <button class="mobile-nav-toggle" id="mobile-nav-toggle" aria-label="Toggle navigation">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <h1>
            <span class="brand">AGRO</span>
            <span class="tagline">Another Good RAG Option</span>
        </h1>
        <div class="top-actions">
            <input id="global-search" type="search" placeholder="Search settings (Ctrl+K)">
            <div id="search-results"></div>
            <select id="theme-mode" name="THEME_MODE" title="Theme Mode" style="background: var(--input-bg); color: var(--fg); border:1px solid var(--line); padding:6px 8px; border-radius:6px;">
                <option value="auto">Auto</option>
                <option value="dark">Dark</option>
                <option value="light">Light</option>
            </select>
            <button id="btn-health">Health</button>
            <span id="health-status">—</span>
        </div>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay"></div>
    <nav class="mobile-nav-drawer" id="mobile-nav-drawer">
        <button data-tab="start">🚀 Get Started</button>
        <button class="active" data-tab="dashboard">📊 Dashboard</button>
        <button data-tab="chat">💬 Chat</button>
        <button data-tab="config">⚙️ Configuration</button>
        <button data-tab="data">🗄️ Data & Indexing</button>
        <button data-tab="devtools">🛠️ Developer Tools</button>
        <button data-tab="analytics">📈 Analytics</button>
        <button data-tab="settings">⚙️ Settings</button>
    </nav>

    <div class="layout">
        <div class="resize-handle"></div>
        <div class="content">
            <div class="tab-bar">
                <button data-tab="start">🚀 Get Started</button>
                <button class="active" data-tab="dashboard">📊 Dashboard</button>
                <button data-tab="chat">💬 Chat</button>
                <button data-tab="config">⚙️ Configuration</button>
                <button data-tab="data">🗄️ Data & Indexing</button>
                <button data-tab="reranker">🧠 Learning Reranker</button>
                <button data-tab="devtools">🛠️ Developer Tools</button>
                <button data-tab="analytics">📈 Analytics</button>
                <button data-tab="metrics">📊 Metrics</button>
                <button data-tab="settings">⚙️ Settings</button>
            </div>

            <!-- Tab: Dashboard -->
            <div id="tab-dashboard" class="tab-content active">
                <!-- Compact Status + Quick Actions -->
                <div class="settings-section" style="background: var(--panel); border-left: 3px solid var(--accent);">
                    <div style="display: grid; grid-template-columns: 300px 1fr; gap: 24px; align-items: start;">
                        <!-- Left: Status Overview -->
                        <div>
                            <h3 style="font-size: 14px; margin-bottom: 16px; color: var(--accent); display: flex; align-items: center; gap: 8px;">
                                <span style="width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px var(--accent);"></span>
                                System Status
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--card-bg); border-radius: 4px; border: 1px solid var(--line);">
                                    <span style="font-size: 11px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px;">Health</span>
                                    <span id="dash-health" class="mono" style="color: var(--ok); font-weight: 600;">—</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--card-bg); border-radius: 4px; border: 1px solid var(--line);">
                                    <span style="font-size: 11px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px;">Repo</span>
                                    <span id="dash-repo" class="mono" style="color: var(--fg); font-weight: 600;">—</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--card-bg); border-radius: 4px; border: 1px solid var(--line);">
                                    <span style="font-size: 11px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px;">Cards</span>
                                    <span id="dash-cards" class="mono" style="color: var(--link); font-weight: 600;">—</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--card-bg); border-radius: 4px; border: 1px solid var(--line);">
                                    <span style="font-size: 11px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px;">MCP</span>
                                    <span id="dash-mcp" class="mono" style="color: var(--link); font-weight: 600;">—</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--card-bg); border-radius: 4px; border: 1px solid var(--line);">
                                    <span style="font-size: 11px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px;">Auto-Tune</span>
                                    <span id="dash-autotune" class="mono" style="color: var(--warn); font-weight: 600;">—</span>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Quick Actions -->
                        <div>
                            <h3 style="font-size: 14px; margin-bottom: 16px; color: var(--warn); display: flex; align-items: center; gap: 8px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                                </svg>
                                Quick Actions
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px;">
                                <button class="action-btn" id="btn-generate-keywords" data-action="generate-keywords">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2l2.39 4.85L20 8l-4 3.9.95 5.54L12 15.77 7.05 17.45 8 11.9 4 8l5.61-1.15L12 2z"></path>
                                    </svg>
                                    <span>Generate Keywords</span>
                                </button>
                                <button class="action-btn" id="dash-change-repo" data-action="change-repo">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                                    </svg>
                                    <span>Change Repo</span>
                                </button>
                                <button class="action-btn" id="dash-index-start" data-action="index">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                    </svg>
                                    <span>Run Indexer</span>
                                </button>
                                <button class="action-btn" id="dash-reload-config" data-action="reload">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="23 4 23 10 17 10"></polyline>
                                        <polyline points="1 20 1 14 7 14"></polyline>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    <span>Reload Config</span>
                                </button>
                                <button class="action-btn" id="dash-cards-refresh" data-action="refresh">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="1 4 1 10 7 10"></polyline>
                                        <polyline points="23 20 23 14 17 14"></polyline>
                                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                                    </svg>
                                    <span>Refresh Status</span>
                                </button>
                            </div>

                            <!-- Status Display -->
                            <div id="dash-index-status" style="background: var(--code-bg); border: 1px solid var(--line); border-radius: 6px; padding: 12px; font-family: 'SF Mono', monospace; font-size: 12px; line-height: 1.6; color: var(--fg-muted); min-height: 48px;"></div>

                            <!-- Progress Bar -->
                            <div style="margin-top: 12px; background: var(--card-bg); border: 1px solid var(--line); border-radius: 4px; height: 8px; overflow: hidden;">
                                <div id="dash-index-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--warn) 0%, var(--accent) 100%); transition: width 0.3s ease, opacity 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section wizard">
                    <h3><span class="accent-blue">●</span> Auto-Profile</h3>
                    <p class="small" style="margin-bottom:20px; color: var(--fg-muted); line-height: 1.6; font-size: 14px;">
                        The only platform where you can mix any provider, model, and database.
                        We analyze your hardware and budget to configure the optimal RAG automatically.
                    </p>

                    <div style="display: grid; grid-template-columns: 400px 1fr; gap: 24px;">
                        <!-- Left: Input Panel -->
                        <div>
                            <div class="input-group" style="margin-bottom: 20px;">
                                <label>Monthly Budget ($)</label>
                                <input type="number" id="budget" value="0" min="0" placeholder="0" style="font-size:16px;padding:12px;">
                            </div>

                            <div class="input-row" style="margin-bottom: 8px;">
                                <div class="input-group">
                                    <label><span style="color: var(--warn);">Auto‑Profile Engine</span></label>
                                    <div style="display:flex;align-items:center;gap:10px;">
                                        <input type="checkbox" id="apv2-enabled" style="width:auto;">
                                        <span style="font-size:12px;color: var(--fg-muted);">Use v2 engine (deterministic selector)</span>
                                    </div>
                                </div>
                            </div>

                            <button class="small-button" id="btn-wizard-oneclick" style="background: var(--accent); color: var(--accent-contrast); border:none;width:100%;padding:14px 20px;font-size:15px;font-weight:700;margin-bottom:16px;">
                                Configure Automatically
                            </button>

                            <div id="scan-out" class="result-display" style="display:none;"></div>

                            <div style="margin-top:12px;background: var(--card-bg); border:1px solid var(--line); border-radius:8px; padding:16px;">
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                                    <span style="font-size:12px;color: var(--fg-muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Quick Options</span>
                                </div>
                                <div style="display:flex;flex-direction:column;gap:8px;">
                                    <button class="small-button" style="background: var(--bg-elev2); border:1px solid var(--line); color: var(--fg-muted);" onclick="document.getElementById('budget').value=0;document.getElementById('btn-wizard-oneclick').click();">
                                        Free Tier (Local Only)
                                    </button>
                                    <button class="small-button" style="background: var(--bg-elev2); border:1px solid var(--line); color: var(--fg-muted);" onclick="document.getElementById('budget').value=10;document.getElementById('btn-wizard-oneclick').click();">
                                        Starter ($10/mo)
                                    </button>
                                    <button class="small-button" style="background: var(--bg-elev2); border:1px solid var(--line); color: var(--fg-muted);" onclick="document.getElementById('budget').value=50;document.getElementById('btn-wizard-oneclick').click();">
                                        Professional ($50/mo)
                                    </button>
                                    <button class="small-button" style="background: var(--bg-elev2); border:1px solid var(--line); color: var(--fg-muted);" onclick="document.getElementById('budget').value=200;document.getElementById('btn-wizard-oneclick').click();">
                                        Enterprise ($200/mo)
                                    </button>
                                </div>
                            </div>

                            <!-- Advanced (v2) -->
                            <div style="margin-top:12px;background: var(--card-bg); border:1px solid var(--line); border-radius:8px; padding:16px;">
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;cursor:pointer;" onclick="this.nextElementSibling.style.display = (this.nextElementSibling.style.display==='none'?'block':'none');">
                                    <span style="font-size:12px;color: var(--fg-muted); text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Advanced (v2)</span>
                                    <span style="font-size:12px;color: var(--fg-muted);">toggle</span>
                                </div>
                                <div id="apv2-advanced" style="display:none;">
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label>Objective</label>
                                            <select id="apv2-mode">
                                                <option value="balanced">Balanced</option>
                                                <option value="cost">Cost</option>
                                                <option value="performance">Performance</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label>Monthly Budget (override)</label>
                                            <input type="number" id="apv2-budget" placeholder="uses Budget if empty">
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <div class="input-group full-width">
                                            <label>Providers Allowed</label>
                                            <div style="display:flex;flex-wrap:wrap;gap:10px;">
                                                <label style="font-size:12px;color: var(--fg-muted);"><input type="checkbox" value="openai" class="apv2-prov" style="width:auto;"> openai</label>
                                                <label style="font-size:12px;color: var(--fg-muted);"><input type="checkbox" value="anthropic" class="apv2-prov" style="width:auto;"> anthropic</label>
                                                <label style="font-size:12px;color: var(--fg-muted);"><input type="checkbox" value="google" class="apv2-prov" style="width:auto;"> google</label>
                                                <label style="font-size:12px;color: var(--fg-muted);"><input type="checkbox" value="voyage" class="apv2-prov" style="width:auto;"> voyage</label>
                                                <label style="font-size:12px;color: var(--fg-muted);"><input type="checkbox" value="cohere" class="apv2-prov" style="width:auto;"> cohere</label>
                                                <label style="font-size:12px;color: var(--fg-muted);"><input type="checkbox" value="local" class="apv2-prov" style="width:auto;"> local</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label>Regions Allowed (CSV)</label>
                                            <input type="text" id="apv2-regions" placeholder="us,eu">
                                        </div>
                                        <div class="input-group">
                                            <label>Compliance (CSV)</label>
                                            <input type="text" id="apv2-compliance" placeholder="soc2,hipaa">
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label>Requests/Day</label>
                                            <input type="number" id="apv2-rpd" placeholder="e.g. 100">
                                        </div>
                                        <div class="input-group">
                                            <label>Tokens In / Request</label>
                                            <input type="number" id="apv2-tin" placeholder="e.g. 600">
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label>Tokens Out / Request</label>
                                            <input type="number" id="apv2-tout" placeholder="e.g. 1200">
                                        </div>
                                        <div class="input-group">
                                            <label>Multi‑Query Rewrites</label>
                                            <input type="number" id="apv2-mq" placeholder="e.g. 4">
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label>Embed Tokens / Request</label>
                                            <input type="number" id="apv2-embt" placeholder="optional">
                                        </div>
                                        <div class="input-group">
                                            <label>Rerank Tokens / Request</label>
                                            <input type="number" id="apv2-rrt" placeholder="optional">
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <div class="input-group">
                                            <label>Latency Target (ms)</label>
                                            <input type="number" id="apv2-latency" placeholder="optional">
                                        </div>
                                        <div class="input-group">
                                            <label>Min Throughput (QPS)</label>
                                            <input type="number" id="apv2-minqps" placeholder="optional">
                                        </div>
                                    </div>
                                    <div class="input-row">
                                        <div class="input-group full-width">
                                            <label>Heuristic Quality Fallback</label>
                                            <div style="display:flex;align-items:center;gap:10px;">
                                                <input type="checkbox" id="apv2-heuristics" style="width:auto;">
                                                <span style="font-size:12px;color:var(--fg-muted);">Use heuristics when prices.json lacks quality_score (advanced)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Results Panel -->
                        <div id="profile-results-panel" style="background: var(--card-bg); border:1px solid var(--line); border-radius:8px; padding:24px; min-height:500px;">
                            <div id="profile-placeholder" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color: var(--fg-muted); text-align:center;">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom:16px;opacity:0.3;">
                                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    <path d="M9 12h6m-6 4h6"/>
                                </svg>
                                <p style="font-size:14px;line-height:1.6;max-width:300px;">
                                    Click "Configure Automatically" or select a quick option to generate your optimized RAG profile based on your hardware and budget.
                                </p>
                            </div>
                            <div id="profile-results-content" style="display:none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        <!-- Tab: Onboarding -->
        <div id="tab-onboarding" class="tab-content">
            <div class="ob-container">
                <!-- Progress indicator -->
                <div class="ob-progress-dots">
                    <span class="ob-dot active" data-step="1">1</span>
                    <span class="ob-dot" data-step="2">2</span>
                    <span class="ob-dot" data-step="3">3</span>
                    <span class="ob-dot" data-step="4">4</span>
                    <span class="ob-dot" data-step="5">5</span>
                </div>

                <!-- Step 1: Welcome -->
                <div id="onboard-welcome" class="ob-step active">
                    <div class="ob-main">
                        <h2 class="ob-title">Welcome to AGRO</h2>
                        <p class="ob-subtitle">Point AGRO at a folder or repo; in ~3 minutes it will answer questions about it.</p>

                        <div class="ob-info-box">
                            <p>We scan text, markdown, code, and docs. Nothing leaves your computer unless you turn on cloud.</p>
                            <p>You can always start offline (keywords only) and add 'meaning' later.</p>
                        </div>

                        <!-- Source choice cards -->
                        <div class="ob-choice-cards">
                            <button class="ob-card" data-choice="folder">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <h3>Use a Folder on This Computer</h3>
                                <p>Index local files and docs</p>
                            </button>
                            <button class="ob-card" data-choice="github">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                                </svg>
                                <h3>Use a GitHub Repo</h3>
                                <p>Clone and index a repository</p>
                            </button>
                        </div>

                        <!-- Helpful links -->
                        <div class="ob-links">
                            <h4>Helpful Resources:</h4>
                            <div class="ob-link-grid">
                                <a href="/docs/START_HERE.md" target="_blank">Getting Started</a>
                                <a href="/docs/API_GUI.md" target="_blank">GUI Overview</a>
                                <a href="/docs/QUICKSTART_MCP.md" target="_blank">MCP Quickstart</a>
                                <a href="/docs/MODEL_RECOMMENDATIONS.md" target="_blank">Model Recommendations</a>
                                <a href="/docs/PERFORMANCE_AND_COST.md" target="_blank">Performance & Cost</a>
                                <a href="/docs/MCP_README.md" target="_blank">MCP Details</a>
                                <a href="/files/README.md" target="_blank">README</a>
                                <a href="https://github.com/openai/codex" target="_blank">Codex CLI ↗</a>
                                <a href="https://platform.openai.com/docs/guides/tools-connectors-mcp" target="_blank">MCP Guide ↗</a>
                                <a href="https://openai.github.io/openai-agents-python/" target="_blank">Agents SDK ↗</a>
                                <a href="https://openai.com/index/introducing-agentkit/" target="_blank">AgentKit ↗</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Add Your Stuff -->
                <div id="onboard-source" class="ob-step">
                    <div class="ob-main">
                        <h2 class="ob-title">Add Your Code and Docs</h2>

                        <!-- Mode switcher -->
                        <div class="ob-mode-tabs">
                            <button class="ob-mode-tab active" data-mode="folder">📁 Folder</button>
                            <button class="ob-mode-tab" data-mode="github">🔗 GitHub</button>
                        </div>

                        <!-- Folder mode -->
                        <div id="onboard-folder-mode" class="ob-mode-content active">
                            <div class="ob-input-group">
                                <label>Choose Folder</label>
                                <input type="file" id="onboard-folder-picker" webkitdirectory directory multiple style="display:none;">
                                <div class="ob-file-input">
                                    <button id="onboard-folder-btn" class="ob-browse-btn">Browse...</button>
                                    <span id="onboard-folder-display" class="ob-file-display">No folder selected</span>
                                </div>
                                <p class="ob-hint">Or enter path manually:</p>
                                <input type="text" id="onboard-folder-path" class="ob-text-input" placeholder="/path/to/your/project">
                            </div>
                        </div>

                        <!-- GitHub mode -->
                        <div id="onboard-github-mode" class="ob-mode-content">
                            <div class="ob-input-group">
                                <label>Repository URL</label>
                                <input type="text" id="onboard-github-url" class="ob-text-input" placeholder="https://github.com/owner/repo">
                            </div>
                            <div class="ob-input-group">
                                <label>Branch (optional)</label>
                                <input type="text" id="onboard-github-branch" class="ob-text-input" placeholder="main">
                            </div>
                            <div class="ob-input-group">
                                <label>Personal Access Token (optional)</label>
                                <input type="password" id="onboard-github-token" class="ob-text-input" placeholder="ghp_...">
                                <p class="ob-hint">Only used to clone; not stored unless you save this as a Project.</p>
                            </div>
                        </div>

                        <div class="ob-info-box">
                            We only read files you point us to. Nothing leaves your computer unless you turn on cloud.
                        </div>
                    </div>
                </div>

                <!-- Step 3: Index & Enrich -->
                <div id="onboard-index" class="ob-step">
                    <div class="ob-main">
                        <h2 class="ob-title">Build Your Indexes</h2>

                        <!-- Stage indicators -->
                        <div class="ob-stages">
                            <div class="ob-stage" data-stage="scan">
                                <div class="ob-stage-dot"></div>
                                <span>Light Scan</span>
                            </div>
                            <div class="ob-stage-arrow">→</div>
                            <div class="ob-stage" data-stage="keywords">
                                <div class="ob-stage-dot"></div>
                                <span>Keywords & Cards</span>
                            </div>
                            <div class="ob-stage-arrow">→</div>
                            <div class="ob-stage" data-stage="smart">
                                <div class="ob-stage-dot"></div>
                                <span>Smart Search</span>
                            </div>
                        </div>

                        <!-- Progress bar -->
                        <div class="ob-progress-bar">
                            <div id="onboard-index-bar" class="ob-progress-fill"></div>
                        </div>
                        <div id="onboard-index-status" class="ob-progress-text">Ready to index</div>

                        <!-- Index log -->
                        <div id="onboard-index-log" class="ob-log"></div>

                        <!-- Info tooltip -->
                        <div class="ob-info-box">
                            <div class="ob-tooltip-header">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                                <span>How it works</span>
                            </div>
                            <p>We always keep a BM25 'keyword' index (works offline). When available, we add a dense 'meaning' index so it understands phrasing. If the smart part isn't ready, we fall back to keywords—so it always works.</p>
                        </div>

                        <!-- Fallback message -->
                        <div id="onboard-index-fallback" class="ob-warning-box" style="display:none;">
                            Continuing with keywords only. Dense search can be added later.
                        </div>
                    </div>
                </div>

                <!-- Step 4: Ask Your First Questions -->
                <div id="onboard-questions" class="ob-step">
                    <div class="ob-main">
                        <h2 class="ob-title">Ask Your Codebase</h2>
                        <p class="ob-subtitle">Try these Golden Questions (you can edit them)</p>

                        <!-- Questions -->
                        <div class="ob-questions-list">
                            <div class="ob-question-item">
                                <input type="text" id="onboard-q1" class="ob-question-input" value="Where is hybrid retrieval implemented?">
                                <button class="ob-ask-btn" data-q="1">Ask</button>
                                <div id="onboard-ans-1" class="ob-answer"></div>
                                <a href="#" id="onboard-trace-1" class="ob-trace-link" style="display:none;">What happened under the hood?</a>
                                <div id="onboard-trace-panel-1" class="ob-trace-panel" style="display:none;"></div>
                            </div>
                            <div class="ob-question-item">
                                <input type="text" id="onboard-q2" class="ob-question-input" value="Where are indexing settings?">
                                <button class="ob-ask-btn" data-q="2">Ask</button>
                                <div id="onboard-ans-2" class="ob-answer"></div>
                                <a href="#" id="onboard-trace-2" class="ob-trace-link" style="display:none;">What happened under the hood?</a>
                                <div id="onboard-trace-panel-2" class="ob-trace-panel" style="display:none;"></div>
                            </div>
                            <div class="ob-question-item">
                                <input type="text" id="onboard-q3" class="ob-question-input" value="How do I change the default model?">
                                <button class="ob-ask-btn" data-q="3">Ask</button>
                                <div id="onboard-ans-3" class="ob-answer"></div>
                                <a href="#" id="onboard-trace-3" class="ob-trace-link" style="display:none;">What happened under the hood?</a>
                                <div id="onboard-trace-panel-3" class="ob-trace-panel" style="display:none;"></div>
                            </div>
                        </div>

                        <button id="onboard-save-golden" class="ob-secondary-btn">Save these as Golden Questions</button>
                    </div>
                </div>

                <!-- Step 5: Tune & Save -->
                <div id="onboard-tune" class="ob-step">
                    <div class="ob-main">
                        <h2 class="ob-title">Tune and Save Your Project</h2>

                        <!-- Sliders -->
                        <div class="ob-sliders">
                            <div class="ob-slider-group">
                                <label>Faster ← → Thorough</label>
                                <input type="range" id="onboard-slider-speed" min="1" max="4" value="2" step="1">
                                <div class="ob-slider-labels">
                                    <span>Fast</span>
                                    <span>Balanced</span>
                                    <span>Thorough</span>
                                </div>
                            </div>

                            <div class="ob-slider-group">
                                <label>Cheapest ← → Smartest</label>
                                <input type="range" id="onboard-slider-quality" min="1" max="3" value="2" step="1">
                                <div class="ob-slider-labels">
                                    <span>Local/Free</span>
                                    <span>Balanced</span>
                                    <span>Best Quality</span>
                                </div>
                            </div>

                            <div class="ob-slider-group">
                                <label>Local ← → Cloud</label>
                                <input type="range" id="onboard-slider-cloud" min="1" max="2" value="1" step="1">
                                <div class="ob-slider-labels">
                                    <span>Local Only</span>
                                    <span>Cloud APIs</span>
                                </div>
                            </div>
                        </div>

                        <!-- Settings summary -->
                        <div id="onboard-settings-summary" class="ob-settings-box">
                            <h4>Settings to Apply:</h4>
                            <div id="onboard-summary-content" class="ob-summary-content"></div>
                        </div>

                        <!-- Action buttons -->
                        <div class="ob-actions">
                            <button id="onboard-save-project" class="ob-primary-btn">Save as a Project</button>
                            <button id="onboard-run-eval" class="ob-secondary-btn">Run a Tiny Evaluation</button>
                        </div>

                        <!-- Eval progress -->
                        <div id="onboard-eval-progress" class="ob-eval-box" style="display:none;">
                            <div class="ob-progress-bar">
                                <div id="onboard-eval-bar" class="ob-progress-fill"></div>
                            </div>
                            <div id="onboard-eval-status" class="ob-progress-text">Running evaluation...</div>
                            <div id="onboard-eval-result" class="ob-eval-result"></div>
                        </div>
                    </div>
                </div>

                <!-- Mini help panel (persistent) -->
                <div class="ob-help-panel">
                    <h4>Have questions?</h4>
                    <p>Ask in plain English. We'll help.</p>
                    <textarea id="onboard-help-input" class="ob-help-input" placeholder="Type your question..."></textarea>
                    <button id="onboard-help-send" class="ob-help-btn">Ask</button>
                    <div id="onboard-help-results" class="ob-help-results"></div>

                    <div class="ob-help-pills">
                        <button class="ob-help-pill" data-q="What is BM25?">What is BM25?</button>
                        <button class="ob-help-pill" data-q="What is dense retrieval?">What is dense retrieval?</button>
                        <button class="ob-help-pill" data-q="How long does indexing take?">How long does indexing take?</button>
                    </div>

                    <a href="#" id="onboard-open-chat" class="ob-help-link">Open full Chat →</a>
                </div>

                <!-- Navigation footer -->
                <div class="ob-footer">
                    <button id="onboard-back" class="ob-nav-btn" style="display:none;">← Back</button>
                    <button id="onboard-next" class="ob-nav-btn ob-nav-primary">Next →</button>
                </div>
            </div>
        </div>

            <!-- Tab: Chat -->
            <div id="tab-chat" class="tab-content">
                <div class="settings-section" style="border-left: 3px solid var(--link); padding: 0;">
                    <div style="display: flex; flex-direction: column; height: 70vh;">
                        <!-- Chat Header -->
                        <div style="padding: 16px; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0 0 4px 0;"><span class="accent-blue">●</span> RAG Chat</h3>
                                <p class="small" style="margin: 0; color: var(--fg-muted);">Ask questions about your codebase</p>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="chat-repo-select" style="background: var(--card-bg); border: 1px solid var(--line); color: var(--fg); padding: 6px 12px; border-radius: 4px; font-size: 12px;">
                                    <option value="">Auto-detect repo</option>
                                    <option value="agro">agro</option>
                                    <option value="scrypted">scrypted</option>
                                </select>

                                <!-- History Button with Dropdown -->
                                <div style="position: relative;">
                                    <button id="chat-history" style="background: var(--bg-elev2); color: var(--accent); border: 1px solid var(--accent); padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12 6 12 12 16 14"></polyline>
                                        </svg>
                                        History
                                    </button>
                                    <div id="history-dropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 180px;">
                                        <button id="chat-export-history" style="display: block; width: 100%; text-align: left; background: none; border: none; color: var(--fg); padding: 8px 12px; font-size: 12px; cursor: pointer; transition: background 0.2s;">
                                            📥 Export History
                                        </button>
                                        <div style="height: 1px; background: var(--line);"></div>
                                        <button id="chat-clear-history" style="display: block; width: 100%; text-align: left; background: none; border: none; color: var(--err); padding: 8px 12px; font-size: 12px; cursor: pointer; transition: background 0.2s;">
                                            🗑️ Clear History
                                        </button>
                                    </div>
                                </div>

                                <button id="chat-clear" style="background: var(--bg-elev2); color: var(--err); border: 1px solid var(--err); padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Clear</button>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 16px; background: var(--card-bg);">
                            <div style="text-align: center; color: var(--fg-muted); padding: 40px 20px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.3; margin-bottom: 12px;">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <div>Start a conversation with your codebase</div>
                                <div style="font-size: 11px; margin-top: 8px;">Try: "Where is OAuth token validated?" or "How do we handle API errors?"</div>
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div style="padding: 16px; border-top: 1px solid var(--line); background: var(--code-bg);">
                            <div style="display: flex; gap: 8px;">
                                <textarea
                                    id="chat-input"
                                    placeholder="Ask a question about your codebase..."
                                    style="flex: 1; background: var(--card-bg); border: 1px solid var(--line); color: var(--fg); padding: 12px; border-radius: 6px; font-size: 14px; font-family: inherit; resize: none; min-height: 60px; max-height: 120px;"
                                    rows="2"
                                ></textarea>
                                <button
                                    id="chat-send"
                                    style="background: var(--accent); color: var(--accent-contrast); border: none; padding: 12px 24px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; height: fit-content; align-self: flex-end;"
                                >Send</button>
                            </div>
                            <div style="font-size: 11px; color: var(--fg-muted); margin-top: 8px;">
                                Press Ctrl+Enter to send • Citations will appear as clickable file links
                            </div>
                            <details id="chat-trace" style="margin-top:8px;">
                                <summary style="cursor:pointer;">Routing Trace</summary>
                                <div id="chat-trace-output" class="result-display" style="min-height:120px;white-space:pre-wrap;margin-top:8px;"></div>
                            </details>
                        </div>
                    </div>
                </div>

                <!-- Chat Settings -->
                <div class="settings-section collapsible-section" style="border-left: 3px solid var(--warn); margin-top: 16px;">
                    <h3 class="collapsible-header" data-target="chat-settings-content">
                        <span class="collapse-icon">▼</span>
                        <span class="accent-orange">●</span> Chat Settings
                        <span class="tooltip-wrap">
                            <span class="help-icon">?</span>
                            <div class="tooltip-bubble">
                                <span class="tt-title">Chat Configuration</span>
                                These settings control how the RAG chat behaves. Chat is the main interface for querying your codebase, so tune these carefully for your use case.
                                <div class="tt-badges">
                                    <span class="tt-badge info">Affects quality</span>
                                    <span class="tt-badge info">Affects latency</span>
                                </div>
                            </div>
                        </span>
                    </h3>
                    <div id="chat-settings-content" class="collapsible-content">
                    <p class="small">Configure model, retrieval, and display options for chat. Settings persist in browser localStorage.</p>

                    <!-- Model Selection -->
                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Chat Model (GEN_MODEL_CHAT)
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Chat-Specific Model</span>
                                        Override generation model for chat interface. Falls back to GEN_MODEL if not set. Examples: gpt-4o-mini, gpt-4o, qwen3-coder:14b (local). Larger models = better quality + higher cost/latency.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Affects cost</span>
                                            <span class="tt-badge info">Affects latency</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="text" id="chat-model" placeholder="e.g., gpt-4o-mini (leave empty for default)">
                        </div>
                        <div class="input-group">
                            <label>
                                Temperature
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Response Creativity</span>
                                        Controls randomness. 0.0 = deterministic/factual, 1.0 = creative/varied. For code Q&A, stay low (0.1-0.3). Higher temps good for brainstorming/docs.
                                    </div>
                                </span>
                            </label>
                            <input type="number" id="chat-temperature" value="0.0" min="0" max="2" step="0.01">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Max Response Tokens
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Response Length Limit</span>
                                        Maximum tokens in generated response. ~4 chars = 1 token. 500 tokens ≈ short answer, 2000 ≈ detailed explanation. Higher = more cost.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Affects cost</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" id="chat-max-tokens" value="1000" min="100" max="4000" step="100">
                        </div>
                        <div class="input-group">
                            <label>
                                Multi-Query Rewrites
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Query Expansion</span>
                                        Rewrite query N times for better recall. 1 = no expansion (fastest), 3-4 = good balance, 6+ = thorough but slower. Use higher for "Where is X?" questions.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Affects latency</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" id="chat-multi-query" value="3" min="1" max="6">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Retrieval Top-K
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Results to Retrieve</span>
                                        How many code chunks to retrieve and pass to the model. Top 5 chunks typically used for generation. Higher = more context but slower/costlier.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Affects latency</span>
                                            <span class="tt-badge info">Affects cost</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" id="chat-final-k" value="20" min="5" max="50" step="5">
                        </div>
                        <div class="input-group">
                            <label>
                                Confidence Threshold
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Answer Gate</span>
                                        Minimum confidence to return answer without fallback. 0.55-0.65 typical. Lower = more answers (might guess), higher = fewer answers (more "I don't know").
                                    </div>
                                </span>
                            </label>
                            <input type="number" id="chat-confidence" value="0.55" min="0.3" max="0.9" step="0.05">
                        </div>
                    </div>

                    <!-- Display Options -->
                    <h4 style="margin: 24px 0 12px 0; font-size: 14px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px;">Display Options</h4>
                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Show Citations Inline
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Inline File References</span>
                                        Display file paths and line numbers inline with the answer. Citations become clickable links.
                                    </div>
                                </span>
                            </label>
                            <select id="chat-show-citations">
                                <option value="1">Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>
                                Show Confidence Score
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Retrieval Confidence</span>
                                        Display the retrieval confidence score (0-1) with each answer. Helps judge answer quality.
                                    </div>
                                </span>
                            </label>
                            <select id="chat-show-confidence">
                                <option value="0">No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Auto-scroll to New Messages
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Scroll Behavior</span>
                                        Automatically scroll to bottom when new messages arrive.
                                    </div>
                                </span>
                            </label>
                            <select id="chat-auto-scroll">
                                <option value="1">Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>
                                Syntax Highlighting
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Code Block Highlighting</span>
                                        Apply syntax highlighting to code blocks in responses (future feature).
                                    </div>
                                </span>
                            </label>
                            <select id="chat-syntax-highlight">
                                <option value="0">Basic</option>
                                <option value="1">Full (WIP)</option>
                            </select>
                        </div>
                    </div>

                    <!-- System Prompt -->
                    <div class="input-group" style="margin-top: 16px;">
                        <label>
                            Custom System Prompt
                            <span class="tooltip-wrap">
                                <span class="help-icon">?</span>
                                <div class="tooltip-bubble">
                                    <span class="tt-title">System Instructions</span>
                                    Override default system prompt. Leave empty to use expert prompt (Scrypted plugin development + AGRO RAG specialist). Use to change tone, add rules, etc.
                                </div>
                            </span>
                        </label>
                        <textarea id="chat-system-prompt" placeholder="Leave empty for expert system prompt (Scrypted plugin dev + AGRO RAG expert)" style="min-height: 80px;"></textarea>
                    </div>

                    <!-- History Settings Section -->
                    <div class="settings-subsection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--line);">
                        <h4 style="color: var(--accent); font-size: 13px; margin-bottom: 12px;">
                            💾 History Settings
                            <span class="tooltip-wrap">
                                <span class="help-icon">?</span>
                                <div class="tooltip-bubble">
                                    <span class="tt-title">Chat History Storage</span>
                                    Control how chat history is stored and loaded. History is saved in browser localStorage for persistence across sessions.
                                    <div class="tt-badges">
                                        <span class="tt-badge info">Browser storage</span>
                                        <span class="tt-badge info">Privacy: stays local</span>
                                    </div>
                                </div>
                            </span>
                        </h4>

                        <div class="input-row">
                            <div class="input-group">
                                <label>
                                    Enable History
                                    <span class="tooltip-wrap">
                                        <span class="help-icon">?</span>
                                        <div class="tooltip-bubble">
                                            <span class="tt-title">Save Chat Messages</span>
                                            When enabled, all chat messages are saved to browser localStorage for later retrieval.
                                        </div>
                                    </span>
                                </label>
                                <select id="chat-history-enabled">
                                    <option value="1">Enabled</option>
                                    <option value="0">Disabled</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>
                                    History Limit
                                    <span class="tooltip-wrap">
                                        <span class="help-icon">?</span>
                                        <div class="tooltip-bubble">
                                            <span class="tt-title">Maximum Messages</span>
                                            Maximum number of messages to keep in history. Older messages are automatically removed when limit is reached. Range: 1-1000 messages.
                                        </div>
                                    </span>
                                </label>
                                <input type="number" id="chat-history-limit" value="100" min="1" max="1000" step="10">
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>
                                    Load on Startup
                                    <span class="tooltip-wrap">
                                        <span class="help-icon">?</span>
                                        <div class="tooltip-bubble">
                                            <span class="tt-title">Auto-Load History</span>
                                            Automatically display previous conversation history when opening the chat tab.
                                        </div>
                                    </span>
                                </label>
                                <select id="chat-show-history-on-load">
                                    <option value="1">Yes</option>
                                    <option value="0">No</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Storage Usage</label>
                                <div style="background: var(--card-bg); border: 1px solid var(--line); color: var(--fg-muted); padding: 9px 12px; border-radius: 4px; font-size: 13px; font-family: 'SF Mono', monospace;">
                                    <span id="chat-storage-display">Calculating...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 16px; display: flex; gap: 8px;">
                        <button id="chat-save-settings" class="small-button" style="background: var(--accent); color: var(--accent-contrast);">Save Settings</button>
                        <button id="chat-reset-settings" class="small-button" style="background: var(--bg-elev2); color: var(--err); border: 1px solid var(--err);">Reset to Defaults</button>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Analytics - Cost -->
            <div id="tab-analytics-cost" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn active" data-subtab="analytics-cost" data-parent="analytics">Cost</button>
                    <button class="subtab-btn" data-subtab="analytics-performance" data-parent="analytics">Performance</button>
                    <button class="subtab-btn" data-subtab="analytics-tracing" data-parent="analytics">Tracing</button>
                    <button class="subtab-btn" data-subtab="analytics-usage" data-parent="analytics">Usage</button>
                </div>
                <div id="storage-calculator-container"></div>
            </div>

            <!-- Tab: Learning Reranker (Dedicated Tab) -->
            <div id="tab-reranker" class="tab-content">
                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h2 style="color: var(--link);">🧠 Learning Reranker System</h2>
                    <p class="small">Self-improving retrieval through user feedback. Trains a cross-encoder that learns from thumbs-up/down and clicks to rank better results higher - without touching your chat model.</p>
                </div>

                <!-- Status Overview -->
                <div class="settings-section">
                    <h3>📊 System Status</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Reranker Status</label>
                            <div id="reranker-enabled-status" style="padding: 8px; background: var(--card-bg); border-radius: 4px; font-family: 'SF Mono', monospace; font-size: 13px;">...</div>
                        </div>
                        <div class="input-group">
                            <label>Logged Queries</label>
                            <div id="reranker-query-count" style="padding: 8px; background: var(--card-bg); border-radius: 4px; font-family: 'SF Mono', monospace; font-size: 13px;">...</div>
                        </div>
                        <div class="input-group">
                            <label>Training Triplets</label>
                            <div id="reranker-triplet-count" style="padding: 8px; background: var(--card-bg); border-radius: 4px; font-family: 'SF Mono', monospace; font-size: 13px;">...</div>
                        </div>
                    </div>
                </div>

                <!-- Training Workflow -->
                <div class="settings-section" style="border-left: 3px solid var(--accent);">
                    <h3>🎓 Training Workflow</h3>
                    <p class="small">Click buttons below in order. Each step shows progress and results.</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin: 16px 0;">
                        <div style="background: var(--chip-bg); border: 1px solid var(--line); border-radius: 6px; padding: 16px;">
                            <h4 style="margin: 0 0 8px 0; color: var(--link);">1. Mine Triplets</h4>
                            <p style="font-size: 11px; color: var(--fg-muted); margin-bottom: 12px;">Extract training data from logs</p>
                            <button id="reranker-mine-btn" style="width: 100%; background: var(--link); color: var(--fg); border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: 600;">Mine Triplets</button>
                            <div id="reranker-mine-result" style="margin-top: 8px; font-size: 11px; color: var(--fg-muted);"></div>
                        </div>
                        
                        <div style="background: var(--chip-bg); border: 1px solid var(--line); border-radius: 6px; padding: 16px;">
                            <h4 style="margin: 0 0 8px 0; color: var(--accent);">2. Train Model</h4>
                            <p style="font-size: 11px; color: var(--fg-muted); margin-bottom: 12px;">Fine-tune cross-encoder (5-15 min)</p>
                            <button id="reranker-train-btn" style="width: 100%; background: var(--accent); color: var(--accent-contrast); border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: 600;">Train Model</button>
                            <div id="reranker-train-result" style="margin-top: 8px; font-size: 11px; color: var(--fg-muted);"></div>
                        </div>
                        
                        <div style="background: var(--chip-bg); border: 1px solid var(--line); border-radius: 6px; padding: 16px;">
                            <h4 style="margin: 0 0 8px 0; color: var(--warn);">3. Evaluate</h4>
                            <p style="font-size: 11px; color: var(--fg-muted); margin-bottom: 12px;">Measure MRR and Hit@K metrics</p>
                            <button id="reranker-eval-btn" style="width: 100%; background: var(--warn); color: var(--fg); border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: 600;">Evaluate</button>
                            <div id="reranker-eval-result" style="margin-top: 8px; font-size: 11px; color: var(--fg-muted);"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid var(--link);">
                        <div style="font-size: 12px; color: var(--fg-muted); margin-bottom: 4px;">Current Task:</div>
                        <div id="reranker-status" style="font-size: 14px; font-family: 'SF Mono', monospace; color: var(--fg-muted);">Ready</div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="settings-section">
                    <h3>⚙️ Reranker Configuration</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Enable Learning Reranker</label>
                            <select name="AGRO_RERANKER_ENABLED">
                                <option value="0">OFF</option>
                                <option value="1">ON</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Model Path</label>
                            <input type="text" name="AGRO_RERANKER_MODEL_PATH" placeholder="models/cross-encoder-agro" value="models/cross-encoder-agro">
                        </div>
                        <div class="input-group">
                            <label>Telemetry Log Path</label>
                            <input type="text" name="AGRO_LOG_PATH" placeholder="data/logs/queries.jsonl" value="data/logs/queries.jsonl">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Blend Alpha (CE Weight)</label>
                            <input type="number" name="AGRO_RERANKER_ALPHA" value="0.7" min="0.0" max="1.0" step="0.05">
                        </div>
                        <div class="input-group">
                            <label>Max Sequence Length</label>
                            <input type="number" name="AGRO_RERANKER_MAXLEN" value="512" min="128" max="1024" step="64">
                        </div>
                        <div class="input-group">
                            <label>Batch Size (Inference)</label>
                            <input type="number" name="AGRO_RERANKER_BATCH" value="16" min="1" max="64" step="4">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Training Epochs</label>
                            <input type="number" id="reranker-epochs" value="2" min="1" max="10">
                        </div>
                        <div class="input-group">
                            <label>Training Batch Size</label>
                            <input type="number" id="reranker-batch" value="16" min="1" max="64" step="4">
                        </div>
                    </div>
                </div>

                <!-- Evaluation Results -->
                <div class="settings-section" style="border-left: 3px solid var(--warn);">
                    <h3>📊 Evaluation Metrics</h3>
                    <div id="reranker-metrics-display" style="background: var(--card-bg); border-radius: 6px; padding: 16px; min-height: 120px;">
                        <div style="color: var(--fg-muted); text-align: center; padding: 20px;">No evaluation results yet. Click "Evaluate" above.</div>
                    </div>
                    
                    <div class="input-row" style="margin-top: 16px;">
                        <div class="input-group">
                            <button id="reranker-save-baseline" style="background: var(--link); color: var(--on-link); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">Save as Baseline</button>
                        </div>
                        <div class="input-group">
                            <button id="reranker-compare-baseline" style="background: var(--warn); color: var(--on-warn); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; width: 100%;">Compare vs Baseline</button>
                        </div>
                        <div class="input-group">
                            <button id="reranker-rollback" style="background: var(--err); color: var(--on-err); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">Rollback Model</button>
                        </div>
                    </div>
                </div>

                <!-- Log Viewer -->
                <div class="settings-section">
                    <h3>📝 Query Logs</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <button id="reranker-view-logs" style="background: var(--bg-elev1); color: var(--fg); border: 1px solid var(--line); padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">View Logs</button>
                        </div>
                        <div class="input-group">
                            <button id="reranker-download-logs" style="background: var(--bg-elev1); color: var(--fg); border: 1px solid var(--line); padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">Download Logs</button>
                        </div>
                        <div class="input-group">
                            <button id="reranker-clear-logs" style="background: var(--err); color: var(--on-err); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">Clear Logs</button>
                        </div>
                    </div>
                    <div id="reranker-logs-viewer" style="margin-top: 16px; background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; padding: 12px; max-height: 400px; overflow-y: auto; display: none; font-family: 'SF Mono', monospace; font-size: 11px;"></div>
                </div>

                <!-- Automation -->
                <div class="settings-section" style="border-left: 3px solid var(--warn);">
                    <h3>🔄 Automation</h3>
                    <p class="small">Set up nightly training to automatically improve the reranker.</p>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label>Nightly Training Time</label>
                            <input type="time" id="reranker-cron-time" value="02:15">
                        </div>
                        <div class="input-group">
                            <label>&nbsp;</label>
                            <button id="reranker-setup-cron" style="background: var(--link); color: var(--on-link); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">Setup Nightly Job</button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 8px;">
                        <button id="reranker-remove-cron" style="background: var(--err); color: var(--on-err); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">Remove Nightly Job</button>
                    </div>
                    
                    <div id="reranker-cron-status" style="margin-top: 12px; padding: 8px; background: var(--card-bg); border-radius: 4px; font-size: 12px; color: var(--fg-muted);"></div>
                </div>

                <!-- Smoke Test -->
                <div class="settings-section" style="border-left: 3px solid var(--accent);">
                    <h3>🧪 Smoke Test</h3>
                    <p class="small">Verify end-to-end functionality: query → retrieve → rerank → log → feedback.</p>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Test Query</label>
                            <input type="text" id="reranker-test-query" placeholder="Where is OAuth validated?" value="Where is OAuth validated?">
                        </div>
                        <div class="input-group">
                            <label>&nbsp;</label>
                            <button id="reranker-smoke-test" style="background: var(--accent); color: var(--accent-contrast); border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; width: 100%;">Run Smoke Test</button>
                        </div>
                    </div>
                    <div id="reranker-smoke-result" style="margin-top: 16px; background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; padding: 12px; display: none; font-family: 'SF Mono', monospace; font-size: 11px;"></div>
                </div>

                <!-- Cost Tracking -->
                <div class="settings-section" style="border-left: 3px solid var(--warn);">
                    <h3>💰 Cost Tracking</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Total Cost (Last 24h)</label>
                            <div id="reranker-cost-24h" style="padding: 8px; background: var(--card-bg); border-radius: 4px; font-family: 'SF Mono', monospace; font-size: 13px; color: var(--accent);">$0.00</div>
                        </div>
                        <div class="input-group">
                            <label>Avg Cost per Query</label>
                            <div id="reranker-cost-avg" style="padding: 8px; background: var(--card-bg); border-radius: 4px; font-family: 'SF Mono', monospace; font-size: 13px; color: var(--accent);">$0.00</div>
                        </div>
                    </div>
                    <button id="reranker-cost-details" style="background: var(--bg-elev1); color: var(--fg); border: 1px solid var(--line); padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 8px; font-weight: 600;">View Cost Breakdown</button>
                </div>

                <!-- No-Hit Tracking -->
                <div class="settings-section" style="border-left: 3px solid var(--err);">
                    <h3>⚠️ No-Hit Queries</h3>
                    <p class="small">Queries that returned no relevant results. Consider reindexing or adding these terms to your corpus.</p>
                    <div id="reranker-nohits-list" style="background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; padding: 12px; max-height: 200px; overflow-y: auto; font-family: 'SF Mono', monospace; font-size: 11px;">
                        <div style="color: var(--fg-muted); text-align: center; padding: 20px;">No no-hit queries tracked yet.</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Developer Tools - Editor -->
            <div id="tab-devtools-editor" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn active" data-subtab="devtools-editor" data-parent="devtools">Editor</button>
                    <button class="subtab-btn" data-subtab="devtools-testing" data-parent="devtools">Testing</button>
                    <button class="subtab-btn" data-subtab="devtools-reranker" data-parent="devtools">🧠 Reranker</button>
                    <button class="subtab-btn" data-subtab="devtools-debug" data-parent="devtools">Debug</button>
                    <button class="subtab-btn" data-subtab="devtools-integrations" data-parent="devtools">Integrations</button>
                </div>
                <div class="settings-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <h3 style="margin: 0;">Embedded Code Editor</h3>
                            <div id="editor-health-badge" style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: var(--fg-muted); color: var(--fg);">
                                <span id="editor-health-text">Checking...</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="btn-editor-open-window" class="small-button" style="background: var(--bg-elev2); color: var(--link); border: 1px solid var(--link);">
                                🗗 Open in Window
                            </button>
                            <button id="btn-editor-copy-url" class="small-button" style="background: var(--bg-elev2); color: var(--accent); border: 1px solid var(--accent);">
                                📋 Copy URL
                            </button>
                            <button id="btn-editor-restart" class="small-button" style="background: var(--bg-elev2); color: var(--warn); border: 1px solid var(--warn);">
                                ↻ Restart
                            </button>
                        </div>
                    </div>

                    <div id="editor-status-banner" style="display: none; background: var(--bg-elev2); border: 1px solid var(--warn); border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 24px;">⚠️</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">Editor Unavailable</div>
                                <div id="editor-status-message" style="font-size: 12px; color: var(--fg-muted);"></div>
                            </div>
                        </div>
                    </div>

                    <div id="editor-iframe-container" style="position: relative; width: 100%; height: calc(100vh - 200px); min-height: 600px; background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; overflow: hidden;">
                        <iframe
                            id="editor-iframe"
                            style="width: 100%; height: 100%; border: none;"
                            sandbox="allow-same-origin allow-scripts allow-forms allow-downloads allow-modals allow-popups"
                        ></iframe>
                    </div>

                    <p class="small" style="color:var(--fg-muted); margin-top: 12px;">
                        Full VS Code experience running in your browser. Changes are saved to the workspace automatically.
                    </p>
                </div>
            </div>


            <!-- Tab: Configuration - Models -->
            <div id="tab-config-models" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn active" data-subtab="config-models" data-parent="config">Models</button>
                    <button class="subtab-btn" data-subtab="config-retrieval" data-parent="config">Retrieval</button>
                    <button class="subtab-btn" data-subtab="config-infra" data-parent="config">Infrastructure</button>
                    <button class="subtab-btn" data-subtab="config-repos" data-parent="config">Repositories</button>
                </div>
                <div class="settings-section">
                    <h3>Generation Models</h3>
                    <button class="small-button" id="btn-add-gen-model" style="margin-bottom:12px;">Add Model</button>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Primary Model (GEN_MODEL)</label>
                            <input type="text" name="GEN_MODEL" placeholder="gpt-4o-mini or qwen3-coder:30b" list="gen-model-list">
                            <datalist id="gen-model-list"></datalist>
                        </div>
                        <div class="input-group">
                            <label>OpenAI API Key</label>
                            <input type="password" name="OPENAI_API_KEY">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Default Temperature (GEN_TEMPERATURE)
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Default Response Creativity</span>
                                        Sets a global default temperature for generation. 0.0 = deterministic; try 0.2 sometimes, or 0.04 for light variation in docs.
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="GEN_TEMPERATURE" value="0.0" min="0" max="2" step="0.01">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Enrich Model (ENRICH_MODEL)</label>
                            <input type="text" name="ENRICH_MODEL" placeholder="gpt-4o-mini">
                        </div>
                        <div class="input-group">
                            <label>Enrich Model (Ollama)</label>
                            <input type="text" name="ENRICH_MODEL_OLLAMA" placeholder="qwen3-coder:30b">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Anthropic API Key</label>
                            <input type="password" name="ANTHROPIC_API_KEY">
                        </div>
                        <div class="input-group">
                            <label>Google API Key</label>
                            <input type="password" name="GOOGLE_API_KEY">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Ollama URL</label>
                            <input type="text" name="OLLAMA_URL" placeholder="http://127.0.0.1:11434">
                        </div>
                        <div class="input-group">
                            <label>OpenAI Base URL (optional)</label>
                            <input type="text" name="OPENAI_BASE_URL" placeholder="For vLLM proxy">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>HTTP Override Model</label>
                            <input type="text" name="GEN_MODEL_HTTP">
                        </div>
                        <div class="input-group">
                            <label>MCP Override Model</label>
                            <input type="text" name="GEN_MODEL_MCP">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>CLI Override Model</label>
                            <input type="text" name="GEN_MODEL_CLI">
                        </div>
                        <div class="input-group">
                            <label>Enrich Backend</label>
                            <select name="ENRICH_BACKEND">
                                <option value="">Default</option>
                                <option value="openai">OpenAI</option>
                                <option value="mlx">MLX (Apple)</option>
                                <option value="ollama">Ollama</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Tab: Configuration - Retrieval -->
            <div id="tab-config-retrieval" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="config-models" data-parent="config">Models</button>
                    <button class="subtab-btn active" data-subtab="config-retrieval" data-parent="config">Retrieval</button>
                    <button class="subtab-btn" data-subtab="config-infra" data-parent="config">Infrastructure</button>
                    <button class="subtab-btn" data-subtab="config-repos" data-parent="config">Repositories</button>
                </div>
                <div class="settings-section">
                    <h3>Retrieval Parameters</h3>
                    <p class="small">Hybrid search fuses sparse (BM25) + dense (vectors). These knobs tune candidate counts and hydration behavior.</p>
                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Multi-Query Rewrites
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Multi-Query Expansion</span>
                                        Number of query variations to generate for better recall. Each variant searches independently, results are merged and reranked. Higher = better recall but more API calls. Default: 2. Range: 1-6.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Better Recall</span>
                                            <span class="tt-badge warn">Higher Cost</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="MQ_REWRITES" value="2" min="1">
                        </div>
                        <div class="input-group">
                            <label>
                                Final K
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Final Results Count</span>
                                        Number of top results to return after fusion and reranking. This is what you get back from search. Higher = more context but more noise. Default: 10. Range: 5-30.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Core Setting</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="FINAL_K" value="10" min="1">
                        </div>
                        <div class="input-group">
                            <label>
                                Use Semantic Synonyms
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Semantic Synonym Expansion</span>
                                        Expands queries with semantic synonyms to improve retrieval. Example: "auth" → "auth authentication oauth jwt bearer". Defined in semantic_synonyms.json. Default: ON.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Better Recall</span>
                                            <span class="tt-badge">No Re-index</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <select name="USE_SEMANTIC_SYNONYMS">
                                <option value="1">ON</option>
                                <option value="0">OFF</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Top-K Dense (Qdrant)
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Dense Vector Candidates</span>
                                        Number of candidates to retrieve from Qdrant vector search before fusion. Higher = better recall for semantic matches but slower. Should be >= Final K. Default: 75. Range: 20-200.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Semantic Search</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="TOPK_DENSE" value="75" min="1">
                        </div>
                        <div class="input-group">
                            <label>Vector Backend</label>
                            <select name="VECTOR_BACKEND">
                                <option value="qdrant">Qdrant</option>
                                <option value="faiss">FAISS (experimental)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>
                                Top-K Sparse (BM25)
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Sparse BM25 Candidates</span>
                                        Number of candidates to retrieve from BM25 keyword search before fusion. Higher = better recall for exact matches but slower. Should be >= Final K. Default: 75. Range: 20-200.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Keyword Search</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="TOPK_SPARSE" value="75" min="1">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Hydration Mode
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Code Loading Strategy</span>
                                        Controls when full code is loaded. "Lazy" loads code from chunks.jsonl after retrieval. "None" only returns metadata (file path, line numbers). Lazy is recommended. None is faster but returns no code.
                                        <div class="tt-badges">
                                            <span class="tt-badge">Lazy Recommended</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <select name="HYDRATION_MODE">
                                <option value="lazy">Lazy</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>
                                Hydration Max Chars
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Code Truncation Limit</span>
                                        Maximum characters to load per chunk when hydrating. Prevents huge chunks from bloating responses. 0 = no limit. Default: 2000. Range: 500-5000.
                                        <div class="tt-badges">
                                            <span class="tt-badge">Performance</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="HYDRATION_MAX_CHARS" value="2000">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Vendor Mode
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">First-Party vs Vendor Code</span>
                                        Controls scoring bonus for first-party vs vendor code. "Prefer First Party" boosts your code (+0.06) and penalizes vendor libs (-0.08). "Prefer Vendor" boosts vendor code. Most use cases prefer first party.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Code Priority</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <select name="VENDOR_MODE">
                                <option value="prefer_first_party">Prefer First Party</option>
                                <option value="prefer_vendor">Prefer Vendor</option>
                            </select>
                        </div>
                    </div>
                    
                </div>

                <div class="settings-section" style="margin-top:16px; border-left: 3px solid var(--link);">
                    <h3>
                        <span class="accent-pink">●</span> Reranking
                        <span class="tooltip-wrap">
                            <span class="help-icon">?</span>
                            <div class="tooltip-bubble">
                                <span class="tt-title">Cross‑Encoder Reranking</span>
                                Configure reranking backend and models. Set to "none" for offline/BM25‑only operation.
                                <div class="tt-badges">
                                    <span class="tt-badge info">Quality Boost</span>
                                    <span class="tt-badge warn">May require downloads</span>
                                </div>
                            </div>
                        </span>
                    </h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Rerank Backend (RERANK_BACKEND)</label>
                            <select name="RERANK_BACKEND">
                                <option value="none">none</option>
                                <option value="local">local</option>
                                <option value="hf">hf</option>
                                <option value="cohere">cohere</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Local/HF Model (RERANKER_MODEL)</label>
                            <input type="text" name="RERANKER_MODEL" placeholder="BAAI/bge-reranker-v2-m3">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Cohere Model (COHERE_RERANK_MODEL)</label>
                            <select name="COHERE_RERANK_MODEL">
                                <option value="">(select model)</option>
                                <option value="rerank-3.5">rerank-3.5</option>
                                <option value="rerank-english-v3.0">rerank-english-v3.0</option>
                                <option value="rerank-multilingual-v3.0">rerank-multilingual-v3.0</option>
                                <option value="rerank-english-lite-v3.0">rerank-english-lite-v3.0</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Cohere API Key (COHERE_API_KEY)</label>
                            <input type="password" name="COHERE_API_KEY" placeholder="ck_...">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>HF Trust Remote Code (TRANSFORMERS_TRUST_REMOTE_CODE)</label>
                            <select name="TRANSFORMERS_TRUST_REMOTE_CODE">
                                <option value="1">1</option>
                                <option value="0">0</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Input Snippet Chars (RERANK_INPUT_SNIPPET_CHARS)</label>
                            <input type="number" name="RERANK_INPUT_SNIPPET_CHARS" value="700" min="200" max="2000" step="50">
                        </div>
                    </div>
                </div>

                <!-- Advanced RAG Tuning -->
                <div class="settings-section" style="border-left: 3px solid var(--warn);">
                    <h3>
                        <span class="accent-orange">●</span> Advanced RAG Tuning
                        <span class="tooltip-wrap">
                            <span class="help-icon">?</span>
                            <div class="tooltip-bubble">
                                <span class="tt-title">Advanced Parameters</span>
                                Fine-tune scoring, fusion, and iteration behavior. These parameters significantly affect retrieval quality and performance. Only modify if you understand the implications.
                                <div class="tt-badges">
                                    <span class="tt-badge warn">Expert Only</span>
                                    <span class="tt-badge">No Re-index</span>
                                </div>
                            </div>
                        </span>
                    </h3>
                    <p class="small">Expert-level controls for fusion weighting, score bonuses, and LangGraph iteration behavior. Changes take effect immediately without re-indexing.</p>

                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                RRF K Divisor
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Reciprocal Rank Fusion (RRF)</span>
                                        Controls how RRF weights sparse (BM25) vs dense (vector) results. Lower values = stronger fusion effect. Formula: score += 1/(K + rank). Default: 60. Range: 10-100.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Affects Fusion</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="RRF_K_DIV" value="60" min="10" max="100" step="5">
                        </div>
                        <div class="input-group">
                            <label>
                                Card Bonus
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Card Matching Bonus</span>
                                        Score boost applied to chunks matched via card-based retrieval. Cards are high-level summaries used for "where is X done?" queries. Default: 0.08. Range: 0.0-0.2.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Improves Intent</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="CARD_BONUS" value="0.08" min="0" max="0.2" step="0.01">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Filename Boost (Exact Match)
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Filename Exact Match Multiplier</span>
                                        Multiplier applied when query terms match the filename exactly. For example, query "auth.py" matching file "auth.py". Boosts precision for file-specific queries. Default: 1.5. Range: 1.0-3.0.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Precision Boost</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="FILENAME_BOOST_EXACT" value="1.5" min="1.0" max="3.0" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>
                                Filename Boost (Partial Match)
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Path Component Match Multiplier</span>
                                        Multiplier applied when query terms match any part of the file path (directory names, partial filename). For example, query "auth" matching "src/auth/oauth.py". Default: 1.2. Range: 1.0-2.0.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Recall Boost</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="FILENAME_BOOST_PARTIAL" value="1.2" min="1.0" max="2.0" step="0.1">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                LangGraph Final K
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">LangGraph Document Count</span>
                                        Number of documents retrieved for LangGraph RAG pipeline (used by /answer endpoint). Higher = more context but slower + costlier. Separate from retrieval Final K. Default: 20. Range: 5-50.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Context Window</span>
                                            <span class="tt-badge warn">Higher Cost</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="LANGGRAPH_FINAL_K" value="20" min="5" max="50" step="1">
                        </div>
                        <div class="input-group">
                            <label>
                                Max Query Rewrites
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Iteration Limit</span>
                                        Maximum number of query rewrite iterations in LangGraph when confidence is low. Each iteration generates a new query variant and retrieves again. Default: 3. Range: 1-5.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Adaptive Search</span>
                                            <span class="tt-badge warn">Higher Latency</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="MAX_QUERY_REWRITES" value="3" min="1" max="5" step="1">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label>
                                Fallback Confidence Threshold
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Low-Confidence Fallback</span>
                                        When initial retrieval confidence is below this threshold, triggers a fallback multi-query search with expanded parameters. Lower = more aggressive fallback. Default: 0.55. Range: 0.3-0.8.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Recall Safety Net</span>
                                            <span class="tt-badge warn">Extra API Calls</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <input type="number" name="FALLBACK_CONFIDENCE" value="0.55" min="0.3" max="0.8" step="0.05">
                        </div>
                    </div>
                </div>

                <div class="settings-section" style="margin-top:16px; border-left:3px solid var(--link);">
                    <h3>Routing Trace</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Load Latest Trace</label>
                            <button class="small-button" id="btn-trace-latest">Open</button>
                        </div>
                        <div class="input-group">
                            <label>Open in LangSmith</label>
                            <button class="small-button" id="btn-trace-open-ls">Open</button>
                        </div>
                        <div class="input-group">
                            <label>Tracing Mode</label>
                            <select name="TRACING_MODE">
                                <option value="off">Off</option>
                                <option value="local">Local</option>
                                <option value="langsmith">LangSmith</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Auto-open in LangSmith</label>
                            <select name="TRACE_AUTO_LS">
                                <option value="0">No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Trace Retention</label>
                            <input type="number" name="TRACE_RETENTION" value="50" min="1" max="500">
                        </div>
                    </div>
                    <div id="trace-output" class="result-display" style="min-height:120px;white-space:pre-wrap"></div>
                </div>
            </div>


            <!-- Tab: Configuration - Infrastructure -->
            <div id="tab-config-infra" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="config-models" data-parent="config">Models</button>
                    <button class="subtab-btn" data-subtab="config-retrieval" data-parent="config">Retrieval</button>
                    <button class="subtab-btn active" data-subtab="config-infra" data-parent="config">Infrastructure</button>
                    <button class="subtab-btn" data-subtab="config-repos" data-parent="config">Repositories</button>
                </div>
                <div class="settings-section">
                    <h3>Infrastructure</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Qdrant URL</label>
                            <input type="text" name="QDRANT_URL" value="http://127.0.0.1:6333">
                        </div>
                        <div class="input-group">
                            <label>Redis URL</label>
                            <input type="text" name="REDIS_URL" value="redis://127.0.0.1:6379/0">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Repo Root</label>
                            <input type="text" name="REPO_ROOT" placeholder="Override project root (optional)">
                        </div>
                        <div class="input-group">
                            <label>Files Root</label>
                            <input type="text" name="FILES_ROOT" placeholder="/files mount root (optional)">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Active Repository</label>
                            <select name="REPO" id="repo-select"></select>
                        </div>
                        <div class="input-group">
                            <label>Collection Suffix</label>
                            <input type="text" name="COLLECTION_SUFFIX" placeholder="default">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Collection Name</label>
                            <input type="text" name="COLLECTION_NAME" placeholder="code_chunks_{REPO}">
                        </div>
                        <div class="input-group">
                            <label>Repo Path (fallback)</label>
                            <input type="text" name="REPO_PATH" placeholder="/path/to/repo">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>GUI Directory</label>
                            <input type="text" name="GUI_DIR" placeholder="./gui">
                        </div>
                        <div class="input-group">
                            <label>Docs Directory</label>
                            <input type="text" name="DOCS_DIR" placeholder="./docs">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Data Directory</label>
                            <input type="text" name="DATA_DIR" placeholder="./data">
                        </div>
                        <div class="input-group">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Repos File</label>
                            <input type="text" name="REPOS_FILE" value="./repos.json">
                        </div>
                        <div class="input-group">
                            <label>Out Dir Base</label>
                            <input type="text" name="OUT_DIR_BASE" placeholder="./out.noindex or ./out">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>RAG Out Base</label>
                            <input type="text" name="RAG_OUT_BASE" placeholder="Override for OUT_DIR_BASE">
                        </div>
                        <div class="input-group">
                            <label>MCP HTTP Host</label>
                            <input type="text" name="MCP_HTTP_HOST" value="0.0.0.0">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>MCP HTTP Port</label>
                            <input type="number" name="MCP_HTTP_PORT" value="8013">
                        </div>
                        <div class="input-group">
                            <label>MCP HTTP Path</label>
                            <input type="text" name="MCP_HTTP_PATH" value="/mcp">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Configuration - Repositories -->
            <div id="tab-config-repos" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="config-models" data-parent="config">Models</button>
                    <button class="subtab-btn" data-subtab="config-retrieval" data-parent="config">Retrieval</button>
                    <button class="subtab-btn" data-subtab="config-infra" data-parent="config">Infrastructure</button>
                    <button class="subtab-btn active" data-subtab="config-repos" data-parent="config">Repositories</button>
                </div>
                <div class="settings-section">
                    <h3>Repository Configuration</h3>
                    <div id="repos-section"></div>
                </div>
            </div>

            <!-- Tab: Data & Indexing -->
            <div id="tab-data-indexing" class="tab-content">
                
                <!-- ONE SIMPLE INDEX BUTTON -->
                <div class="settings-section" style="border-left: 3px solid var(--ok); padding: 32px;">
                    <h2 style="margin: 0 0 24px 0; font-size: 24px; font-weight: 700;">
                        🚀 Index Repository
                    </h2>
                    
                    <div style="max-width: 800px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Repository:</label>
                            <select id="simple-repo-select" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid var(--line); border-radius: 8px; background: var(--input-bg); color: var(--fg);">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 24px;">
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 16px;">
                                <input type="checkbox" id="simple-dense-check" checked style="width: 24px; height: 24px; cursor: pointer;">
                                <span style="font-weight: 600;">Include Dense Embeddings (Recommended)</span>
                            </label>
                            <p style="font-size: 13px; color: var(--fg-muted); margin: 8px 0 0 36px;">Enables semantic vector search via Qdrant</p>
                        </div>
                        
                        <button id="simple-index-btn" style="
                            width: 100%;
                            padding: 20px;
                            font-size: 20px;
                            font-weight: 700;
                            background: var(--ok);
                            color: #000;
                            border: none;
                            border-radius: 12px;
                            cursor: pointer;
                            transition: all 0.2s;
                            box-shadow: 0 4px 12px rgba(0,255,136,0.3);
                        " onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 6px 20px rgba(0,255,136,0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,255,136,0.3)'">
                            🚀 INDEX NOW
                        </button>
                        
                        <pre id="simple-output" style="
                            display: none;
                            margin-top: 24px;
                            padding: 20px;
                            background: var(--code-bg);
                            color: var(--code-fg);
                            border: 2px solid var(--line);
                            border-radius: 8px;
                            font-family: 'SF Mono', 'Consolas', monospace;
                            font-size: 12px;
                            line-height: 1.5;
                            max-height: 600px;
                            overflow-y: auto;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                        "></pre>
                    </div>
                </div>

                <!-- Indexing Operations -->
                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h3>
                        <span style="color: var(--link);">●</span> Build Index
                        <span class="tooltip-wrap">
                            <span class="help-icon">?</span>
                            <div class="tooltip-bubble">
                                <span class="tt-title">Indexing Process</span>
                                Indexing processes your codebase to enable RAG:
                                <ul style="margin-top:8px; padding-left:16px;">
                                    <li>Chunks code into semantic segments</li>
                                    <li>Creates BM25 sparse index</li>
                                    <li>Generates embeddings (OpenAI or local)</li>
                                    <li>Stores vectors in Qdrant</li>
                                </ul>
                                <br>
                                Run after code changes for fresh results.
                            </div>
                        </span>
                    </h3>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label>Repository to Index</label>
                            <select id="index-repo-select" style="background: var(--bg-elev2); color: var(--fg); border: 1px solid var(--line); padding: 8px; border-radius: 4px;">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Embedding Type</label>
                            <select name="EMBEDDING_TYPE" style="background: var(--bg-elev2); color: var(--fg); border: 1px solid var(--line); padding: 8px; border-radius: 4px;">
                                <option value="openai">OpenAI (text-embedding-3-large)</option>
                                <option value="local">Local (BGE-small, no API)</option>
                                <option value="voyage">Voyage AI</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Skip Dense Index</label>
                            <select id="index-skip-dense" style="background: var(--bg-elev2); color: var(--fg); border: 1px solid var(--line); padding: 8px; border-radius: 4px;">
                                <option value="0">No (full index)</option>
                                <option value="1">Yes (BM25 only, faster)</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-row" style="display: flex; gap: 8px;">
                        <button class="small-button" id="btn-index-start" style="flex: 1; background: var(--accent); color: var(--accent-contrast); padding: 12px; font-weight: 600;">
                            ▶ Start Indexing
                        </button>
                        <button class="small-button" id="btn-index-stop" style="flex: 1; background: var(--err); color: var(--fg); padding: 12px; font-weight: 600;">
                            ■ Stop
                        </button>
                    </div>

                    <div style="margin-top: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--accent);">Progress</label>
                        <div class="progress" style="background:var(--card-bg); border:1px solid var(--line); border-radius:6px; height:24px; overflow:hidden;">
                            <div id="index-bar" style="height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--link)); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                                <span id="index-bar-text" style="font-size: 11px; color: var(--accent-contrast); font-weight: 600; mix-blend-mode: difference;"></span>
                            </div>
                        </div>
                        <div id="index-status" class="result-display" style="min-height: 100px; max-height: 300px; overflow-y: auto; margin-top: 12px; background: var(--card-bg); color: var(--fg-muted); padding: 12px; border: 1px solid var(--line); border-radius: 6px; font-family: 'SF Mono', monospace; font-size: 11px; line-height: 1.6; white-space: pre-wrap;"></div>
                    </div>
                </div>

                <!-- Index Settings -->
                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h3>
                        <span style="color: var(--link);">●</span> Advanced Settings
                    </h3>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label>Output Directory Base</label>
                            <input type="text" name="OUT_DIR_BASE" placeholder="./out" value="./out">
                            <p class="small" style="color: var(--fg-muted);">Where to store index files (chunks, BM25, etc.)</p>
                        </div>
                        <div class="input-group">
                            <label>Collection Name</label>
                            <input type="text" name="COLLECTION_NAME" placeholder="code_chunks_{repo}">
                            <p class="small" style="color: var(--fg-muted);">Qdrant collection name (leave empty for auto)</p>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label>Chunk Size (tokens)</label>
                            <input type="number" name="CHUNK_SIZE" value="1000" min="100" max="4000" step="100">
                        </div>
                        <div class="input-group">
                            <label>Chunk Overlap (tokens)</label>
                            <input type="number" name="CHUNK_OVERLAP" value="200" min="0" max="1000" step="50">
                        </div>
                        <div class="input-group">
                            <label>Max Workers</label>
                            <input type="number" name="INDEX_MAX_WORKERS" value="4" min="1" max="16">
                        </div>
                    </div>

                    <button class="small-button" id="btn-save-index-settings" style="background: var(--link); color: var(--accent-contrast); font-weight: 600;">
                        💾 Save Settings
                    </button>
                </div>

                <!-- Index Profiles -->
                <div class="settings-section" style="border-left: 3px solid var(--err);">
                    <h3>
                        <span style="color: var(--err);">●</span> Index Profiles
                        <span class="tooltip-wrap">
                            <span class="help-icon">?</span>
                            <div class="tooltip-bubble">
                                <span class="tt-title">Index Profiles</span>
                                Different index configurations for different use cases:
                                <ul style="margin-top:8px; padding-left:16px;">
                                    <li><strong>shared:</strong> Fast BM25-only, no API calls</li>
                                    <li><strong>full:</strong> BM25 + dense embeddings (best quality)</li>
                                    <li><strong>dev:</strong> Small subset for testing</li>
                                </ul>
                            </div>
                        </span>
                    </h3>
                    
                    <div class="input-row">
                        <div class="input-group" style="flex: 2;">
                            <label>Active Profile</label>
                            <select id="index-profile-select" style="background: var(--bg-elev2); color: var(--fg); border: 1px solid var(--line); padding: 8px; border-radius: 4px;">
                                <option value="shared">Shared (BM25-only, fast)</option>
                                <option value="full">Full (BM25 + embeddings)</option>
                                <option value="dev">Development (small subset)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>&nbsp;</label>
                            <button class="small-button" id="btn-apply-profile" style="background: var(--err); color: var(--fg); font-weight: 600; width: 100%;">
                                Apply Profile
                            </button>
                        </div>
                    </div>

                    <div id="profile-description" style="margin-top: 12px; padding: 12px; background: var(--bg-elev2); border: 1px solid var(--line); border-radius: 6px; font-size: 12px; color: var(--fg-muted);">
                        <!-- Profile details populated by JS -->
                    </div>
                </div>

            </div>

            <!-- Tab: Settings - General -->
            <div id="tab-settings-general" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn active" data-subtab="settings-general" data-parent="settings">General</button>
                    <button class="subtab-btn" data-subtab="settings-integrations" data-parent="settings">Integrations</button>
                    <button class="subtab-btn" data-subtab="settings-docker" data-parent="settings">Docker</button>
                    <button class="subtab-btn" data-subtab="settings-profiles" data-parent="settings">Profiles</button>
                    <button class="subtab-btn" data-subtab="settings-secrets" data-parent="settings">Secrets</button>
                </div>
                <div class="settings-section">
                    <h3>Miscellaneous</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Theme Mode</label>
                            <select name="THEME_MODE" id="misc-theme-mode">
                                <option value="auto">Auto (System)</option>
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                            </select>
                            <p class="small">Controls light/dark theme globally. Top bar selector changes it live.</p>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Edition (AGRO_EDITION)</label>
                            <input type="text" name="AGRO_EDITION" placeholder="oss | pro | enterprise">
                        </div>
                        <div class="input-group">
                            <label>Thread ID</label>
                            <input type="text" name="THREAD_ID" placeholder="http or cli-chat">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Serve Host</label>
                            <input type="text" name="HOST" value="127.0.0.1">
                        </div>
                        <div class="input-group">
                            <label>Serve Port</label>
                            <input type="number" name="PORT" value="8012">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Open Browser on Start</label>
                            <select name="OPEN_BROWSER">
                                <option value="1">On</option>
                                <option value="0">Off</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Auto-start Colima (Docker)</label>
                            <select name="AUTO_COLIMA">
                                <option value="1">On</option>
                                <option value="0">Off</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Colima Profile</label>
                            <input type="text" name="COLIMA_PROFILE" placeholder="default">
                        </div>
                        <div class="input-group">
                            <label>agro Path</label>
                            <input type="text" name="agro_PATH">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>LangChain Tracing V2</label>
                            <select name="LANGCHAIN_TRACING_V2">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>LangChain Project</label>
                            <input type="text" name="LANGCHAIN_PROJECT" placeholder="agro">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>LangSmith Endpoint</label>
                            <input type="text" name="LANGCHAIN_ENDPOINT" placeholder="https://api.smith.langchain.com">
                        </div>
                        <div class="input-group">
                            <label>LangSmith API Key</label>
                            <input type="password" name="LANGCHAIN_API_KEY" placeholder="sk-...">
                        </div>
                        <div class="input-group">
                            <label>LangSmith API Key (alias)</label>
                            <input type="password" name="LANGSMITH_API_KEY" placeholder="ls_...">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Netlify API Key</label>
                            <input type="password" name="NETLIFY_API_KEY">
                        </div>
                        <div class="input-group">
                            <label>Netlify Domains</label>
                            <input type="text" name="NETLIFY_DOMAINS">
                        </div>
                    </div>
                </div>

                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h3><span class="accent-blue">●</span> Embedded Editor</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label><input type="checkbox" name="EDITOR_ENABLED" value="1"> Enable Embedded Editor</label>
                            <p class="small">Start OpenVSCode Server container on up.sh</p>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Editor Port</label>
                            <input type="number" name="EDITOR_PORT" value="4440" min="1024" max="65535">
                            <p class="small">Preferred port (auto-increments if busy)</p>
                        </div>
                        <div class="input-group">
                            <label>Bind Mode</label>
                            <select name="EDITOR_BIND">
                                <option value="local">Local only (127.0.0.1)</option>
                                <option value="public">Public (0.0.0.0)</option>
                            </select>
                            <p class="small">Local = secure; Public = accessible from network</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Developer Tools - Testing -->
            <div id="tab-devtools-testing" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="devtools-editor" data-parent="devtools">Editor</button>
                    <button class="subtab-btn active" data-subtab="devtools-testing" data-parent="devtools">Testing</button>
                    <button class="subtab-btn" data-subtab="devtools-reranker" data-parent="devtools">🧠 Reranker</button>
                    <button class="subtab-btn" data-subtab="devtools-debug" data-parent="devtools">Debug</button>
                    <button class="subtab-btn" data-subtab="devtools-integrations" data-parent="devtools">Integrations</button>
                </div>
                <!-- Golden Questions Manager -->
                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h3>
                        <span class="accent-blue">●</span> Golden Questions Manager
                        <span class="tooltip-wrap">
                            <span class="help-icon">?</span>
                            <div class="tooltip-bubble">
                                <span class="tt-title">Golden Questions</span>
                                Questions with known-good answers used to measure RAG quality. Each question should have expected file paths that contain the answer.
                                <div class="tt-badges">
                                    <span class="tt-badge info">Quality Assurance</span>
                                    <span class="tt-badge">No Re-index</span>
                                </div>
                            </div>
                        </span>
                    </h3>
                    <p class="small">Manage test questions for evaluating retrieval quality. Add, edit, test individual questions, or run full evaluation suite.</p>

                    <!-- Add New Question Form -->
                    <div id="golden-add-form" style="background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; padding: 16px; margin-bottom: 16px;">
                        <h4 style="font-size: 13px; color: var(--accent); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Add New Question</h4>
                        <div class="input-group" style="margin-bottom: 12px;">
                            <label>Question Text</label>
                            <textarea id="golden-new-q" placeholder="e.g., Where is OAuth token validated?" style="min-height: 60px;"></textarea>
                        </div>
                        <div class="input-row" style="margin-bottom: 12px;">
                            <div class="input-group">
                                <label>Repository</label>
                                <select id="golden-new-repo">
                                    <option value="agro">agro</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Expected Paths (comma-separated)</label>
                                <input type="text" id="golden-new-paths" placeholder="auth, oauth, token">
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="small-button" id="btn-golden-add" style="background: var(--accent); color: var(--accent-contrast); border: none; width: auto; flex: 1;">Add Question</button>
                            <button class="small-button" id="btn-golden-test-new" style="width: auto;">Test First</button>
                        </div>
                    </div>

                    <!-- Questions List -->
                    <div id="golden-questions-list" style="background: var(--code-bg); border: 1px solid var(--line); border-radius: 6px; padding: 16px; max-height: 400px; overflow-y: auto;">
                        <div id="golden-questions-content" style="font-size: 13px; color: var(--fg-muted);">
                            Loading questions...
                        </div>
                    </div>

                    <div class="action-buttons" style="margin-top: 16px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button id="btn-golden-refresh" style="flex: 1;">Refresh List</button>
                        <button id="btn-golden-load-recommended" style="flex: 1; background: var(--bg-elev2); color: var(--link); border: 1px solid var(--link);">Load Recommended</button>
                        <button id="btn-golden-run-tests" style="flex: 1; background: var(--bg-elev2); color: var(--link); border: 1px solid var(--link);">Run All Tests</button>
                        <button id="btn-golden-export" style="flex: 1; background: var(--bg-elev2); color: var(--accent);">Export JSON</button>
                    </div>
                </div>

                <!-- Evaluation Runner -->
                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h3>
                        <span class="accent-purple">●</span> Evaluation Runner
                        <span class="tooltip-wrap">
                            <span class="help-icon">?</span>
                            <div class="tooltip-bubble">
                                <span class="tt-title">Evaluation System</span>
                                Runs all golden questions and measures retrieval accuracy. Tracks regressions vs. saved baseline.
                                <div class="tt-badges">
                                    <span class="tt-badge info">Accuracy Metrics</span>
                                    <span class="tt-badge warn">Can Be Slow</span>
                                </div>
                            </div>
                        </span>
                    </h3>
                    <p class="small">Run full evaluation suite to measure RAG quality. Compare against baseline to detect regressions.</p>

                    <!-- Settings -->
                    <div class="input-row" style="margin-bottom: 16px;">
                        <div class="input-group">
                            <label>
                                Use Multi-Query
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Multi-Query Expansion</span>
                                        Generate multiple query variations for better recall. Increases API costs but improves accuracy. Recommended: enabled.
                                        <div class="tt-badges">
                                            <span class="tt-badge info">Better Recall</span>
                                            <span class="tt-badge warn">Higher Cost</span>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <select id="eval-use-multi">
                                <option value="1">Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>
                                Final K Results
                                <span class="tooltip-wrap">
                                    <span class="help-icon">?</span>
                                    <div class="tooltip-bubble">
                                        <span class="tt-title">Results Count</span>
                                        Number of results to return per question. Higher = more context but more noise. Recommended: 5-10.
                                    </div>
                                </span>
                            </label>
                            <input type="number" id="eval-final-k" value="5" min="1" max="20">
                        </div>
                    </div>

                    <!-- Run Button -->
                    <button class="action-buttons" id="btn-eval-run" style="width: 100%; background: var(--link); color: var(--accent-contrast); font-size: 15px; padding: 14px;">
                        Run Full Evaluation
                    </button>

                    <!-- Progress -->
                    <div id="eval-progress" style="margin-top: 16px; display: none;">
                        <div style="background: var(--card-bg); border: 1px solid var(--line); border-radius: 4px; height: 8px; overflow: hidden; margin-bottom: 8px;">
                            <div id="eval-progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--link) 0%, var(--accent) 100%); transition: width 0.3s ease;"></div>
                        </div>
                        <div id="eval-status" class="mono" style="font-size: 12px; color: var(--fg-muted); text-align: center;">—</div>
                    </div>

                    <!-- Results Display -->
                    <div id="eval-results" style="margin-top: 16px; display: none;">
                        <!-- Overall Metrics -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; padding: 12px; text-align: center;">
                                <div style="font-size: 11px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Top-1 Accuracy</div>
                                <div id="eval-top1-acc" class="mono" style="font-size: 24px; color: var(--accent); font-weight: 700;">—</div>
                            </div>
                            <div style="background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; padding: 12px; text-align: center;">
                                <div style="font-size: 11px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Top-K Accuracy</div>
                                <div id="eval-topk-acc" class="mono" style="font-size: 24px; color: var(--accent); font-weight: 700;">—</div>
                            </div>
                            <div style="background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; padding: 12px; text-align: center;">
                                <div style="font-size: 11px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Duration</div>
                                <div id="eval-duration" class="mono" style="font-size: 24px; color: var(--link); font-weight: 700;">—</div>
                            </div>
                        </div>

                        <!-- Per-Question Results -->
                        <div id="eval-details" style="background: var(--code-bg); border: 1px solid var(--line); border-radius: 6px; padding: 16px; max-height: 300px; overflow-y: auto;"></div>

                        <!-- Baseline Actions -->
                        <div class="action-buttons" style="margin-top: 16px;">
                            <button id="btn-eval-save-baseline" style="flex: 1;">Save as Baseline</button>
                            <button id="btn-eval-compare" style="flex: 1; background: var(--bg-elev2); color: var(--accent);">Compare to Baseline</button>
                            <button id="btn-eval-export" style="flex: 1; background: var(--bg-elev2); color: var(--accent);">Export Results</button>
                        </div>
                    </div>

                    <!-- Comparison Results -->
                    <div id="eval-comparison" style="margin-top: 16px; display: none;"></div>
                </div>
            </div>

            <!-- Tab: Developer Tools - Debug -->
            <!-- Tab: Developer Tools - Reranker -->
            <div id="tab-devtools-reranker" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="devtools-editor" data-parent="devtools">Editor</button>
                    <button class="subtab-btn" data-subtab="devtools-testing" data-parent="devtools">Testing</button>
                    <button class="subtab-btn active" data-subtab="devtools-reranker" data-parent="devtools">🧠 Reranker</button>
                    <button class="subtab-btn" data-subtab="devtools-debug" data-parent="devtools">Debug</button>
                    <button class="subtab-btn" data-subtab="devtools-integrations" data-parent="devtools">Integrations</button>
                </div>
                
                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h3>🧠 Learning Reranker Training</h3>
                    <p class="small">Train a cross-encoder reranker that learns from user feedback (thumbs up/down) to improve retrieval quality over time. All settings and controls in one place!</p>
                    
                    <div style="background: var(--code-bg); border: 1px solid var(--line); border-radius: 6px; padding: 16px; margin: 16px 0;">
                        <h4 style="margin: 0 0 12px 0; color: var(--accent);">Training Workflow</h4>
                        <ol style="margin: 0; padding-left: 20px; color: var(--fg-muted);">
                            <li>Use the chat (💬 Chat tab) - feedback buttons appear on answers automatically</li>
                            <li>Accumulate ~50+ queries with feedback</li>
                            <li>Mine training triplets from logs → 
                                <button id="reranker-mine-btn" style="background: var(--link); color: var(--fg); border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 8px;">Mine Triplets</button>
                            </li>
                            <li>Train the reranker model (5-15 min on CPU) → 
                                <button id="reranker-train-btn" style="background: var(--accent); color: var(--accent-contrast); border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; margin-left: 8px;">Train Model</button>
                            </li>
                            <li>Evaluate performance → 
                                <button id="reranker-eval-btn" style="background: var(--warn); color: var(--accent-contrast); border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; margin-left: 8px;">Evaluate</button>
                            </li>
                            <li>Enable reranker below and click "Apply All Changes"</li>
                        </ol>
                    </div>
                    
                    <h4 style="margin: 20px 0 12px 0;">⚙️ Reranker Settings</h4>
                    <div style="padding: 12px; background: var(--bg-elev2); border-left: 3px solid var(--accent); margin-bottom: 16px;">
                        <strong style="color: var(--accent);">Note:</strong> Reranker settings are in the <strong>Reranker</strong> tab to avoid conflicts.
                    </div>
                    
                    <!-- These settings are now only in the Reranker tab to avoid duplicate field conflicts -->
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label>Telemetry Log Path</label>
                            <input type="text" name="AGRO_LOG_PATH" placeholder="data/logs/queries.jsonl" value="data/logs/queries.jsonl">
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 12px 0;">🎓 Training Parameters</h4>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label>Training Epochs</label>
                            <input type="number" id="reranker-epochs" value="2" min="1" max="10" style="width: 100px;">
                        </div>
                        <div class="input-group">
                            <label>Training Batch Size</label>
                            <input type="number" id="reranker-batch" value="16" min="1" max="64" step="4" style="width: 100px;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid var(--link);">
                        <div style="font-size: 12px; color: var(--fg-muted); margin-bottom: 4px;">Status:</div>
                        <div id="reranker-status" style="font-size: 14px; font-family: 'SF Mono', monospace; color: var(--fg-muted);">Ready</div>
                    </div>
                    
                    <div style="margin-top: 16px; background: color-mix(in oklch, var(--ok) 8%, var(--bg)); border: 1px solid color-mix(in oklch, var(--ok) 30%, var(--bg)); border-radius: 6px; padding: 12px;">
                        <div style="font-size: 12px; color: var(--accent); margin-bottom: 8px;">✓ How It Works:</div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--fg-muted);">
                            <li>Logs all queries → <code style="background: var(--card-bg); padding: 2px 6px; border-radius: 3px; color: var(--accent);">data/logs/queries.jsonl</code></li>
                            <li>Mines positive (thumbs up, clicked) vs negative (not clicked) pairs</li>
                            <li>Trains cross-encoder to rank good results higher</li>
                            <li>No chat model fine-tuning - only reranker learns!</li>
                            <li>Privacy-safe: Everything runs locally</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="tab-devtools-debug" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="devtools-editor" data-parent="devtools">Editor</button>
                    <button class="subtab-btn" data-subtab="devtools-testing" data-parent="devtools">Testing</button>
                    <button class="subtab-btn" data-subtab="devtools-reranker" data-parent="devtools">🧠 Reranker</button>
                    <button class="subtab-btn active" data-subtab="devtools-debug" data-parent="devtools">Debug</button>
                    <button class="subtab-btn" data-subtab="devtools-integrations" data-parent="devtools">Integrations</button>
                </div>

                <!-- MCP RAG Search (debug) -->
                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h3>
                        <span style="color:var(--link);">●</span> MCP RAG Search (debug)
                    </h3>
                    <p class="small">Runs the MCP server's <code>rag_search</code> tool to return file paths and line ranges. Falls back to local retrieval if MCP is unavailable.</p>
                    <div class="input-row">
                        <div class="input-group full-width">
                            <label>Question</label>
                            <input type="text" id="mcp-rag-q" placeholder="e.g. Where is OAuth token validated?">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Repository</label>
                            <input type="text" id="mcp-rag-repo" placeholder="agro">
                        </div>
                        <div class="input-group">
                            <label>Top K</label>
                            <input type="number" id="mcp-rag-topk" value="10" min="1" max="50">
                        </div>
                        <div class="input-group">
                            <label>Force Local</label>
                            <select id="mcp-rag-local">
                                <option value="false" selected>No (use MCP if available)</option>
                                <option value="true">Yes (bypass MCP)</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <button class="small-button" id="btn-mcp-rag-run">Run</button>
                        </div>
                    </div>
                    <pre id="mcp-rag-results" class="result-display" style="min-height: 120px; white-space: pre-wrap; background: var(--code-bg);"></pre>
                </div>

                <!-- MCP Server Management -->
                <div class="settings-section" style="border-left: 3px solid var(--err);">
                    <h3>
                        <span style="color:var(--err);">●</span> MCP Server Management
                        <span class="tooltip-wrap">
                            <span class="help-icon">?</span>
                            <div class="tooltip-bubble">
                                <span class="tt-title">MCP Server</span>
                                Manage the Model Context Protocol server that exposes RAG tools to Codex CLI, Claude Code, and other MCP-compatible clients.
                                <br><br>
                                <strong>Tools Exposed:</strong>
                                <ul style="margin-top:8px; padding-left:16px;">
                                    <li>rag_answer - Full answer with citations</li>
                                    <li>rag_search - Retrieval only (debugging)</li>
                                    <li>rag_feedback - Submit ratings</li>
                                    <li>netlify_deploy - Trigger builds</li>
                                    <li>web_get - Allowlisted HTTP GET</li>
                                </ul>
                            </div>
                        </span>
                    </h3>
                    
                    <div style="padding: 16px; background: var(--bg-elev2); border: 1px solid var(--link); border-radius: 8px; margin-bottom: 16px;">
                        <div style="color: var(--link); font-weight: 600; margin-bottom: 8px;">ℹ️ Two MCP Modes</div>
                        <p style="color: var(--fg-muted); font-size: 13px; line-height: 1.5;">
                            <strong>1. stdio mode</strong> (local Claude/Codex) - Launched automatically by client<br>
                            <strong>2. HTTP mode</strong> (port 8013) - Runs as daemon for remote access/testing
                        </p>
                    </div>

                    <div class="input-row" style="margin-bottom: 12px;">
                        <div class="input-group" style="flex: 2;">
                            <label>HTTP MCP Status (port 8013)</label>
                            <div id="mcp-http-status" style="font-family: monospace; padding: 12px; background: var(--bg-elev2); border: 1px solid var(--line); border-radius: 4px; color: var(--fg-muted);">
                                Checking...
                            </div>
                        </div>
                        <div class="input-group" style="flex: 1;">
                            <label>&nbsp;</label>
                            <button class="small-button" id="btn-mcp-http-check" style="width: 100%; background: var(--bg-elev2); color: var(--link); border: 1px solid var(--link);">
                                🔍 Refresh
                            </button>
                        </div>
                    </div>

                    <div class="input-row" style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button class="small-button" id="btn-mcp-http-start" style="flex: 1; background: var(--accent); color: var(--accent-contrast);">
                            ▶ Start HTTP MCP
                        </button>
                        <button class="small-button" id="btn-mcp-http-stop" style="flex: 1; background: var(--err); color: var(--fg);">
                            ■ Stop HTTP MCP
                        </button>
                        <button class="small-button" id="btn-mcp-http-restart" style="flex: 1; background: var(--warn); color: var(--accent-contrast);">
                            ↻ Restart
                        </button>
                    </div>

                    <div class="input-row" style="margin-bottom: 16px;">
                        <div class="input-group full-width">
                            <label>Test stdio MCP (local)</label>
                            <button class="small-button" id="btn-mcp-test" style="width: 100%; background: var(--bg-elev2); color: var(--accent); border: 1px solid var(--accent); padding: 12px;">
                                ✓ Test stdio Tools (one-shot test)
                            </button>
                            <pre id="mcp-test-output" style="margin-top: 8px; min-height: 80px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; background: var(--card-bg); color: var(--fg-muted); padding: 12px; border: 1px solid var(--line); border-radius: 4px; font-size: 11px; display: none;"></pre>
                        </div>
                    </div>

                    <div class="input-row" style="margin-top: 12px;">
                        <div class="input-group full-width">
                            <details style="background: var(--bg-elev2); padding: 12px; border-radius: 6px; border: 1px solid var(--line);">
                                <summary style="cursor: pointer; font-weight: 600; color: var(--accent); user-select: none;">
                                    📖 Setup Instructions
                                </summary>
                                <div style="margin-top: 12px; color: var(--fg-muted); line-height: 1.6;">
                                    <h4 style="color: var(--accent); margin-bottom: 8px;">For Codex CLI:</h4>
                                    <pre style="background: var(--card-bg); padding: 8px; border-radius: 4px; overflow-x: auto; margin-bottom: 12px;"><code>codex mcp add rag-service -- python -m server.mcp.server
codex mcp list</code></pre>

                                    <h4 style="color: var(--accent); margin-bottom: 8px;">For Claude Desktop:</h4>
                                    <p style="margin-bottom: 8px;">Add to <code>~/Library/Application Support/Claude/claude_desktop_config.json</code>:</p>
                                    <pre style="background: var(--card-bg); padding: 8px; border-radius: 4px; overflow-x: auto; margin-bottom: 12px;"><code>{
  "mcpServers": {
    "agro-rag": {
      "command": "python",
      "args": ["-m", "server.mcp.server"],
      "cwd": "/Users/davidmontgomery/agro",
      "env": {
        "PATH": "/Users/davidmontgomery/agro/.venv/bin:${PATH}"
      }
    }
  }
}</code></pre>

                                    <h4 style="color: var(--accent); margin-bottom: 8px;">Test from Terminal:</h4>
                                    <pre style="background: var(--card-bg); padding: 8px; border-radius: 4px; overflow-x: auto;"><code>cd /Users/davidmontgomery/agro
. .venv/bin/activate
echo '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}' | python -m server.mcp.server</code></pre>

                                    <p style="margin-top: 12px; padding: 12px; background: var(--card-bg); border-left: 3px solid var(--err); border-radius: 4px;">
                                        <strong style="color: var(--err);">⚠️ Important:</strong> MCP server must be running for agents to access RAG tools. Use the buttons above to manage the server without touching terminal commands.
                                    </p>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>

                <!-- Cards Builder & Viewer -->
                <div class="settings-section" style="border-left: 3px solid var(--accent);">
                    <h3>
                        <span class="accent-green">●</span> Code Cards Builder & Viewer
                        <span class="tooltip-wrap">
                            <span class="help-icon">?</span>
                            <div class="tooltip-bubble">
                                <span class="tt-title">Code Cards</span>
                                High-level semantic summaries of code chunks for faster retrieval with AI-powered enrichment and filtering.
                            </div>
                        </span>
                    </h3>

                    <!-- Repository Selection -->
                    <div class="input-row" style="margin-bottom: 12px;">
                        <div class="input-group">
                            <label>Repository to Build Cards For</label>
                            <select id="cards-repo-select" style="width: 100%;">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="input-row" style="margin-bottom: 12px;">
                        <div class="input-group">
                            <label>Exclude Directories (comma-separated)</label>
                            <input type="text" id="cards-exclude-dirs" placeholder="e.g., node_modules, vendor, dist" style="width: 100%;">
                            <p class="small" style="color:var(--fg-muted);">Directories to skip when building cards</p>
                        </div>
                    </div>

                    <div class="input-row" style="margin-bottom: 12px;">
                        <div class="input-group">
                            <label>Exclude Patterns (comma-separated)</label>
                            <input type="text" id="cards-exclude-patterns" placeholder="e.g., .test.js, .spec.ts, .min.js" style="width: 100%;">
                            <p class="small" style="color:var(--fg-muted);">File patterns to skip</p>
                        </div>
                    </div>

                    <div class="input-row" style="margin-bottom: 16px;">
                        <div class="input-group">
                            <label>Exclude Keywords (comma-separated)</label>
                            <input type="text" id="cards-exclude-keywords" placeholder="e.g., deprecated, legacy, TODO" style="width: 100%;">
                            <p class="small" style="color:var(--fg-muted);">Skip chunks containing these keywords</p>
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="input-row" style="margin-bottom: 16px; align-items: flex-end;">
                        <div class="input-group">
                            <label>Cards Max</label>
                            <input type="number" id="cards-max" name="CARDS_MAX" value="0" min="0" step="10" style="max-width: 160px;">
                            <p class="small" style="color:var(--fg-muted);">Limit chunks (0 = all)</p>
                        </div>
                        <div class="input-group">
                            <label>
                                <input type="checkbox" id="cards-enrich-gui" checked> Enrich with AI
                            </label>
                            <p class="small" style="color:var(--fg-muted);">Use LLM for rich semantic cards</p>
                        </div>
                    </div>

                    <!-- PERMANENT VISIBLE PROGRESS DISPLAY -->
                    <div id="cards-progress-container" style="display: none; background: var(--card-bg); border: 2px solid var(--accent); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-weight: 700; font-size: 16px; color: var(--fg);">⚡ Building Cards...</div>
                            <div id="cards-progress-repo" style="font-size: 12px; font-weight: 600; color: var(--accent);"></div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                            <div id="cards-progress-stage-scan" class="cards-stage-pill" style="font-size: 11px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--line); color: var(--fg-muted); background: transparent;">scan</div>
                            <div id="cards-progress-stage-chunk" class="cards-stage-pill" style="font-size: 11px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--line); color: var(--fg-muted); background: transparent;">chunk</div>
                            <div id="cards-progress-stage-summarize" class="cards-stage-pill" style="font-size: 11px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--line); color: var(--fg-muted); background: transparent;">summarize</div>
                            <div id="cards-progress-stage-sparse" class="cards-stage-pill" style="font-size: 11px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--line); color: var(--fg-muted); background: transparent;">sparse</div>
                            <div id="cards-progress-stage-write" class="cards-stage-pill" style="font-size: 11px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--line); color: var(--fg-muted); background: transparent;">write</div>
                            <div id="cards-progress-stage-finalize" class="cards-stage-pill" style="font-size: 11px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--line); color: var(--fg-muted); background: transparent;">finalize</div>
                        </div>

                        <div style="background: var(--bg-elev1); border: 1px solid var(--line); border-radius: 6px; height: 24px; overflow: hidden; margin-bottom: 8px; position: relative;">
                            <div id="cards-progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--ok) 0%, var(--accent) 100%); transition: width 0.3s ease;"></div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-family: 'SF Mono', monospace; color: var(--fg); margin-bottom: 12px;">
                            <div id="cards-progress-stats" style="font-weight: 600;">0 / 0 (0%)</div>
                            <div id="cards-progress-throughput" style="color: var(--link);">--</div>
                            <div id="cards-progress-eta" style="color: var(--warn);">ETA: --</div>
                        </div>

                        <div id="cards-progress-tip" style="font-size: 12px; color: var(--link); margin-bottom: 12px; font-style: italic; padding: 8px; background: var(--bg-elev2); border-radius: 4px;">
                            💡 Starting...
                        </div>

                        <div style="display: flex; gap: 8px;">
                            <button id="cards-progress-cancel" class="small-button" style="flex: 1; background: var(--err); color: #fff; font-weight: 600;">
                                ■ Cancel Build
                            </button>
                            <button id="cards-progress-logs" class="small-button" style="flex: 1; background: var(--bg-elev2); color: var(--link); border: 1px solid var(--link);">
                                📄 View Logs
                            </button>
                            <button id="cards-progress-clear" class="small-button" style="flex: 1; background: var(--bg-elev2); color: var(--fg-muted); border: 1px solid var(--line);">
                                ✕ Clear
                            </button>
                        </div>
                    </div>

                    <!-- Build Button -->
                    <div class="action-buttons" style="margin-bottom: 16px; display:flex; gap:8px;">
                        <button id="btn-cards-build" style="flex: 1; background: var(--accent); color: var(--fg); font-weight: 600; padding: 12px;">
                            <span style="margin-right: 4px;">⚡</span> Build Cards
                        </button>
                        <button id="btn-cards-refresh" style="flex: 1; background: var(--bg-elev2); color: var(--ok); border: 1px solid var(--ok);">
                            <span style="margin-right: 4px;">↻</span> Refresh
                        </button>
                    </div>

                    <!-- Cards Viewer -->
                    <div id="cards-viewer-container" style="background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; padding: 16px; max-height: 400px; overflow-y: auto;">
                        <div id="cards-last-build" class="mono" style="font-size: 11px; color: var(--fg-muted); margin-bottom: 8px; display:none;"></div>
                        <div id="cards-viewer" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:12px;"></div>
                    </div>
                    <p class="small" style="color: var(--fg-muted); margin-top:8px;">Click a card to navigate to its source location.</p>
                </div>
            </div>

            <!-- Tab: Developer Tools - Integrations -->
            <div id="tab-devtools-integrations" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="devtools-editor" data-parent="devtools">Editor</button>
                    <button class="subtab-btn" data-subtab="devtools-testing" data-parent="devtools">Testing</button>
                    <button class="subtab-btn" data-subtab="devtools-reranker" data-parent="devtools">🧠 Reranker</button>
                    <button class="subtab-btn" data-subtab="devtools-debug" data-parent="devtools">Debug</button>
                    <button class="subtab-btn active" data-subtab="devtools-integrations" data-parent="devtools">Integrations</button>
                </div>

                <div class="settings-section">
                    <h3>Git Hooks (Auto-Index)</h3>
                    <p class="small">Install local git hooks to auto-run BM25 indexing on branch changes and commits. Enable it with <code>AUTO_INDEX=1</code>.</p>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Install Hooks</label>
                            <button class="small-button" id="btn-install-hooks">Install</button>
                        </div>
                        <div class="input-group">
                            <label>Status</label>
                            <div id="hooks-status" class="mono">—</div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group full-width">
                            <label>Enable</label>
                            <input type="text" readonly value="export AUTO_INDEX=1" onclick="this.select();document.execCommand('copy');" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Analytics - Performance -->
            <div id="tab-analytics-performance" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="analytics-cost" data-parent="analytics">Cost</button>
                    <button class="subtab-btn active" data-subtab="analytics-performance" data-parent="analytics">Performance</button>
                    <button class="subtab-btn" data-subtab="analytics-tracing" data-parent="analytics">Tracing</button>
                    <button class="subtab-btn" data-subtab="analytics-usage" data-parent="analytics">Usage</button>
                </div>
                <div class="settings-section">
                    <h3>Performance Metrics</h3>
                    <p class="small">Retrieval quality, latency stats (coming soon)</p>
                </div>
            </div>

            <!-- Tab: Analytics - Tracing -->
            <div id="tab-analytics-tracing" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="analytics-cost" data-parent="analytics">Cost</button>
                    <button class="subtab-btn" data-subtab="analytics-performance" data-parent="analytics">Performance</button>
                    <button class="subtab-btn active" data-subtab="analytics-tracing" data-parent="analytics">Tracing</button>
                    <button class="subtab-btn" data-subtab="analytics-usage" data-parent="analytics">Usage</button>
                </div>

                <!-- LangSmith (Preview) -->
                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h3>
                        <span class="accent-blue">●</span> LangSmith (Preview)
                    </h3>
                    <p class="small">View the real LangSmith run inside AGRO. Uses a shared link for embedding.</p>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Project</label>
                            <input type="text" id="ls-project" placeholder="agro">
                        </div>
                        <div class="input-group">
                            <label>Share</label>
                            <select id="ls-share">
                                <option value="true" selected>Yes (public share link)</option>
                                <option value="false">No (requires login)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <button class="small-button" id="btn-ls-latest">Load Latest</button>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group full-width">
                            <a id="ls-open" href="#" target="_blank" style="display:none;">Open in new tab ↗</a>
                        </div>
                    </div>
                    <div id="ls-embed-wrap" style="position: relative; width: 100%; height: 480px; background: var(--card-bg); border: 1px solid var(--line); border-radius: 6px; overflow: hidden;">
                        <iframe id="ls-iframe" style="width: 100%; height: 100%; border: none; background: var(--panel);"></iframe>
                    </div>
                    <p class="small" id="ls-note" style="color: var(--fg-muted); margin-top:8px; display:none;">If the viewer is blocked by the site, use the "Open in new tab" link above.</p>
                </div>
            </div>

            <!-- Tab: Analytics - Usage -->
            <div id="tab-analytics-usage" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="analytics-cost" data-parent="analytics">Cost</button>
                    <button class="subtab-btn" data-subtab="analytics-performance" data-parent="analytics">Performance</button>
                    <button class="subtab-btn" data-subtab="analytics-tracing" data-parent="analytics">Tracing</button>
                    <button class="subtab-btn active" data-subtab="analytics-usage" data-parent="analytics">Usage</button>
                </div>
                <div class="settings-section">
                    <h3>Usage Statistics</h3>
                    <p class="small">Request counts, token usage over time (coming soon)</p>
                </div>
            </div>

            <!-- Tab: Settings - Integrations -->
            <div id="tab-settings-integrations" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="settings-general" data-parent="settings">General</button>
                    <button class="subtab-btn active" data-subtab="settings-integrations" data-parent="settings">Integrations</button>
                    <button class="subtab-btn" data-subtab="settings-docker" data-parent="settings">Docker</button>
                    <button class="subtab-btn" data-subtab="settings-profiles" data-parent="settings">Profiles</button>
                    <button class="subtab-btn" data-subtab="settings-secrets" data-parent="settings">Secrets</button>
                </div>

                <div class="settings-section">
                    <h3>MCP & Channels</h3>
                    <p class="small">Set per‑channel inference models. Provider is inferred from the model name; use base URL and keys from Infrastructure or Models for proxies/local engines.</p>
                    <div class="input-row">
                        <div class="input-group">
                            <label>HTTP Responses Model</label>
                            <input type="text" name="GEN_MODEL_HTTP" placeholder="override HTTP model">
                        </div>
                        <div class="input-group">
                            <label>MCP stdio Model</label>
                            <input type="text" name="GEN_MODEL_MCP" placeholder="override MCP model">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>CLI Chat Model</label>
                            <input type="text" name="GEN_MODEL_CLI" placeholder="override CLI model">
                        </div>
                        <div class="input-group">
                            <label>MCP HTTP (host/port/path)</label>
                            <div style="display:flex; gap:8px;">
                                <input type="text" name="MCP_HTTP_HOST" placeholder="0.0.0.0" style="width:40%">
                                <input type="number" name="MCP_HTTP_PORT" placeholder="8013" style="width:30%">
                                <input type="text" name="MCP_HTTP_PATH" placeholder="/mcp" style="width:30%">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Settings - Docker -->
            <div id="tab-settings-docker" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="settings-general" data-parent="settings">General</button>
                    <button class="subtab-btn" data-subtab="settings-integrations" data-parent="settings">Integrations</button>
                    <button class="subtab-btn active" data-subtab="settings-docker" data-parent="settings">Docker</button>
                    <button class="subtab-btn" data-subtab="settings-profiles" data-parent="settings">Profiles</button>
                    <button class="subtab-btn" data-subtab="settings-secrets" data-parent="settings">Secrets</button>
                </div>

                <!-- Infrastructure Services -->
                <div class="settings-section" style="border-left: 3px solid var(--warn);">
                    <h3>
                        <span style="color: var(--warn);">●</span> Infrastructure Services
                        <span class="tooltip-wrap">
                            <span class="help-icon">?</span>
                            <div class="tooltip-bubble">
                                <span class="tt-title">Infrastructure</span>
                                Core services for AGRO:
                                <ul style="margin-top:8px; padding-left:16px;">
                                    <li><strong>Qdrant:</strong> Vector database (port 6333)</li>
                                    <li><strong>Redis:</strong> LangGraph memory (port 6379)</li>
                                    <li><strong>Prometheus:</strong> Metrics (port 9090)</li>
                                    <li><strong>Grafana:</strong> Dashboards (port 3000)</li>
                                </ul>
                            </div>
                        </span>
                    </h3>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <!-- Qdrant -->
                        <div style="background: var(--bg-elev2); border: 1px solid var(--line); border-radius: 6px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 600; color: var(--accent);">Qdrant</div>
                                <div id="qdrant-status" style="font-size: 11px; color: var(--fg-muted);">Checking...</div>
                            </div>
                            <div style="font-size: 12px; color: var(--fg-muted); margin-bottom: 12px;">
                                Vector database • Port 6333
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="small-button" id="btn-qdrant-open" style="flex: 1; background: var(--bg-elev2); color: var(--link); border: 1px solid var(--link);">
                                    🌐 Open UI
                                </button>
                                <button class="small-button" id="btn-qdrant-restart" style="flex: 1; background: var(--bg-elev2); color: var(--warn); border: 1px solid var(--warn);">
                                    ↻ Restart
                                </button>
                            </div>
                        </div>

                        <!-- Redis -->
                        <div style="background: var(--bg-elev2); border: 1px solid var(--line); border-radius: 6px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 600; color: var(--err);">Redis</div>
                                <div id="redis-status" style="font-size: 11px; color: var(--fg-muted);">Checking...</div>
                            </div>
                            <div style="font-size: 12px; color: var(--fg-muted); margin-bottom: 12px;">
                                Memory store • Port 6379
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="small-button" id="btn-redis-ping" style="flex: 1; background: var(--bg-elev2); color: var(--err); border: 1px solid var(--err);">
                                    📡 Ping
                                </button>
                                <button class="small-button" id="btn-redis-restart" style="flex: 1; background: var(--bg-elev2); color: var(--warn); border: 1px solid var(--warn);">
                                    ↻ Restart
                                </button>
                            </div>
                        </div>

                        <!-- Prometheus -->
                        <div style="background: var(--bg-elev2); border: 1px solid var(--line); border-radius: 6px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 600; color: var(--warn);">Prometheus</div>
                                <div id="prometheus-status" style="font-size: 11px; color: var(--fg-muted);">Checking...</div>
                            </div>
                            <div style="font-size: 12px; color: var(--fg-muted); margin-bottom: 12px;">
                                Metrics collector • Port 9090
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="small-button" id="btn-prometheus-open" style="flex: 1; background: var(--bg-elev2); color: var(--warn); border: 1px solid var(--warn);">
                                    🌐 Open UI
                                </button>
                            </div>
                        </div>

                        <!-- Grafana -->
                        <div style="background: var(--bg-elev2); border: 1px solid var(--line); border-radius: 6px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 600; color: var(--link);">Grafana</div>
                                <div id="grafana-status" style="font-size: 11px; color: var(--fg-muted);">Checking...</div>
                            </div>
                            <div style="font-size: 12px; color: var(--fg-muted); margin-bottom: 12px;">
                                Dashboards • Port 3000
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="small-button" id="btn-grafana-open" style="flex: 1; background: var(--bg-elev2); color: var(--link); border: 1px solid var(--link);">
                                    🌐 Open UI
                                </button>
                            </div>
                            <div style="font-size: 10px; color: var(--fg-muted); margin-top: 8px;">
                                Login: admin / ********
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px;">
                        <button class="small-button" id="btn-infra-up" style="flex: 1; background: var(--accent); color: var(--accent-contrast); padding: 12px; font-weight: 600;">
                            ▶ Start All Infrastructure
                        </button>
                        <button class="small-button" id="btn-infra-down" style="flex: 1; background: var(--err); color: var(--fg); padding: 12px; font-weight: 600;">
                            ■ Stop All Infrastructure
                        </button>
                    </div>
                </div>

                <!-- Docker Status -->
                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h3>
                        <span style="color: var(--link);">●</span> Docker Status
                        <button class="small-button" id="btn-docker-refresh" style="float: right; padding: 4px 12px; font-size: 11px;">
                            ↻ Refresh All
                        </button>
                    </h3>
                    
                    <div id="docker-status-display" style="margin-bottom: 16px;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Running Containers -->
                <div class="settings-section" style="border-left: 3px solid var(--accent);">
                    <h3>
                        <span style="color: var(--accent);">●</span> All Containers
                        <button class="small-button" id="btn-docker-refresh-containers" style="float: right; padding: 4px 12px; font-size: 11px;">
                            ↻ Refresh
                        </button>
                    </h3>
                    
                    <div id="docker-containers-grid" style="display: grid; gap: 12px; margin-bottom: 16px;">
                        <!-- Container cards populated by JS -->
                    </div>
                </div>

                <!-- Docker Settings -->
                <div class="settings-section" style="border-left: 3px solid var(--link);">
                    <h3>
                        <span style="color: var(--link);">●</span> Docker Settings
                    </h3>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label>Auto-start Colima</label>
                            <select name="AUTO_COLIMA">
                                <option value="1">On (auto-start if needed)</option>
                                <option value="0">Off (manual start)</option>
                            </select>
                            <p class="small" style="color: var(--fg-muted);">Automatically start Colima Docker runtime on macOS</p>
                        </div>
                        <div class="input-group">
                            <label>Colima Profile</label>
                            <input type="text" name="COLIMA_PROFILE" placeholder="default">
                            <p class="small" style="color: var(--fg-muted);">Colima profile name (leave empty for default)</p>
                        </div>
                    </div>

                    <button class="small-button" id="btn-save-docker-settings" style="background: var(--link); color: var(--accent-contrast); font-weight: 600;">
                        💾 Save Settings
                    </button>
                </div>
            </div>

            <!-- Tab: Settings - Profiles -->
            <div id="tab-settings-profiles" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="settings-general" data-parent="settings">General</button>
                    <button class="subtab-btn" data-subtab="settings-integrations" data-parent="settings">Integrations</button>
                    <button class="subtab-btn" data-subtab="settings-docker" data-parent="settings">Docker</button>
                    <button class="subtab-btn active" data-subtab="settings-profiles" data-parent="settings">Profiles</button>
                    <button class="subtab-btn" data-subtab="settings-secrets" data-parent="settings">Secrets</button>
                </div>
                <div class="settings-section">
                    <h3>Configuration Profiles</h3>
                    <p class="small">Save and load configuration profiles</p>
                    <!-- Content will be moved here from sidebar -->
                </div>
            </div>

            <!-- Tab: Settings - Secrets -->
            <div id="tab-settings-secrets" class="tab-content">
                <div class="subtab-bar">
                    <button class="subtab-btn" data-subtab="settings-general" data-parent="settings">General</button>
                    <button class="subtab-btn" data-subtab="settings-integrations" data-parent="settings">Integrations</button>
                    <button class="subtab-btn" data-subtab="settings-docker" data-parent="settings">Docker</button>
                    <button class="subtab-btn" data-subtab="settings-profiles" data-parent="settings">Profiles</button>
                    <button class="subtab-btn active" data-subtab="settings-secrets" data-parent="settings">Secrets</button>
                </div>
                <div class="settings-section">
                    <h3>Secrets Management</h3>
                    <p class="small">Import secrets from .env files</p>
                    <!-- Content will be moved here from sidebar -->
                </div>
            </div>

            <!-- Tab: Metrics & Observability -->
            <div id="tab-metrics" class="tab-content">
                <div class="settings-section">
                    <h3>Grafana Metrics Dashboard</h3>
                    <p class="small">Real-time observability powered by Prometheus + Grafana</p>
                    <div style="margin-top: 16px; border: 1px solid var(--line); border-radius: 8px; overflow: hidden; background: var(--card-bg); padding: 12px;">
                        <div style="font-size:14px;font-weight:700;color:var(--fg);margin-bottom:8px;">Demo Mode</div>
                        <p class="small" style="color: var(--fg-muted); line-height:1.6;">
                            Sorry — the live embedded Grafana dashboard isn't available in this demo.
                            But imagine the following panels streaming live:
                        </p>
                        <ul style="margin:8px 0 12px 18px; line-height:1.6; color: var(--fg);">
                            <li>LangSmith tracing: runs, spans, tokens, error drill‑downs</li>
                            <li>RAG query volume (1m/5m/1h)</li>
                            <li>Top routes and latency percentiles (P50/P95/P99)</li>
                            <li>Answer/context token usage</li>
                            <li>No‑hit queries and routing fallbacks</li>
                            <li>BM25 vs vector hit ratios</li>
                            <li>Reranker confidence and win‑rate</li>
                            <li>Indexing progress and chunk counts per repo</li>
                            <li>Cards builder throughput and stage timings</li>
                            <li>Cost per request (24h / 30d)</li>
                            <li>Provider health checks and error rates</li>
                            <li>Qdrant collections: points, IO, latency</li>
                            <li>Redis cache hit/miss and memory</li>
                            <li>Server CPU / memory utilization</li>
                            <li>Canary results and SLO budget burn</li>
                        </ul>
                        <div class="small" style="color: var(--fg-muted); margin:6px 0 10px;">And because it's a demo…</div>
                        <div style="border:1px solid var(--line); border-radius:6px; padding:10px; background: var(--panel);">
                            <div style="font-weight:700; color: var(--link); margin-bottom:6px;">Here’s that T‑Rex game Google shows when it’s down</div>
                            <canvas id="dino-canvas" width="600" height="140" style="width:100%; max-width:600px; height:160px; background: var(--card-bg); border:1px solid var(--line); border-radius:4px;"></canvas>
                            <div class="small" style="color: var(--fg-muted); margin-top:6px;">Press Space or ↑ to jump. Avoid the cacti.</div>
                        </div>
                        <script src="/agro/js/dino.js"></script>
                    </div>
                </div>
            </div>

            <div class="action-buttons" style="padding: 0 24px 24px;">
                <button id="save-btn">Apply All Changes</button>
            </div>
        </div>

        <!-- Right Sidepanel -->
        <div class="sidepanel">
            <!-- Cost Calculator -->
            <div class="sidepanel-section">
                <h4>Live Cost Calculator
                    <span style="margin-left:8px;display:inline-flex;align-items:center;gap:6px;font-size:10px;color: var(--accent); font-weight:500;text-transform:uppercase;letter-spacing:0.5px;">
                        <span style="width:6px;height:6px;border-radius:50%;background: var(--accent); animation:blink 2s ease-in-out infinite;"></span>
                        LIVE
                    </span>
                </h4>
                <div class="input-group" style="margin-bottom: 12px;">
                    <label>Inference Provider</label>
                    <select id="cost-provider">
                        <option value="openai">openai</option>
                        <option value="anthropic">anthropic</option>
                        <option value="google">google</option>
                        <option value="mistral">mistral</option>
                        <option value="cohere">cohere</option>
                        <option value="local">local</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 12px;">
                    <label>Inference Model</label>
                    <input type="text" id="cost-model" list="model-list" value="gpt-4o-mini">
                    <datalist id="model-list"></datalist>
                </div>
                <div class="input-row" style="margin-bottom: 12px;">
                    <div class="input-group">
                        <label>Embeddings Provider</label>
                        <select id="cost-embed-provider">
                            <option value="">Use current</option>
                            <option value="openai">OpenAI</option>
                            <option value="voyage">Voyage</option>
                            <option value="mxbai">MXBAI</option>
                            <option value="local">Local</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Embedding Model</label>
                        <input type="text" id="cost-embed-model" list="embed-model-list" placeholder="text-embedding-3-small">
                        <datalist id="embed-model-list"></datalist>
                    </div>
                </div>
                <div class="input-row" style="margin-bottom: 12px;">
                    <div class="input-group">
                        <label>Reranker</label>
                        <select id="cost-rerank-provider">
                            <option value="">Use current</option>
                            <option value="cohere">Cohere</option>
                            <option value="hf">Hugging Face</option>
                            <option value="local">Local</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Rerank Model</label>
                        <input type="text" id="cost-rerank-model" list="rerank-model-list" placeholder="rerank-english-v3.0">
                    </div>
                </div>
                <div class="input-row" style="margin-bottom: 12px;">
                    <div class="input-group">
                        <label>Tokens In</label>
                        <input type="number" id="cost-in" value="500">
                    </div>
                    <div class="input-group">
                        <label>Tokens Out</label>
                        <input type="number" id="cost-out" value="800">
                    </div>
                </div>
                <div class="input-row" style="margin-bottom: 12px;">
                    <div class="input-group">
                        <label>Embeds</label>
                        <input type="number" id="cost-embeds" value="0">
                    </div>
                    <div class="input-group">
                        <label>Reranks</label>
                        <input type="number" id="cost-rerank" value="0">
                    </div>
                </div>
                <div class="input-group" style="margin-bottom: 12px;">
                    <label>Requests / Day</label>
                    <input type="number" id="cost-rpd" value="100">
                </div>
                <button class="small-button" id="btn-estimate">Calculate Cost</button>
                <button class="small-button" id="btn-add-cost-model" style="margin-left:8px;">Add Model</button>
                <div class="cost-results">
                    <div class="result-item">
                        <span class="result-label">Daily</span>
                        <span class="result-value" id="cost-daily">—</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Monthly</span>
                        <span class="result-value" id="cost-monthly">—</span>
                    </div>
                </div>
            </div>

            <!-- Profiles (saved list only) -->
            <div class="sidepanel-section">
                <h4>Profiles</h4>
                <div class="input-group" style="margin: 10px 0;">
                    <label>Save Current As</label>
                    <input type="text" id="profile-name" placeholder="my-config">
                </div>
                <button class="small-button" id="btn-save-profile">Save Profile</button>
                <div style="margin-top: 10px;">
                    <label style="margin-bottom: 6px; display: block;">Saved Profiles</label>
                    <ul id="profiles-ul" class="mono" style="list-style: none; padding: 0;"></ul>
                </div>
            </div>

            <!-- Profile Preview Tooltip -->
            <div id="profile-tooltip"></div>

            <!-- Auto-Tune (Pro) -->
            <div class="sidepanel-section">
                <h4>Auto‑Tune</h4>
                <div class="input-row" style="margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="autotune-enabled" style="width: auto;"> Enable Auto‑Tune
                    </label>
                </div>
                <div class="input-row" style="margin-bottom: 8px;">
                    <div>Current Mode: <span id="autotune-mode">—</span></div>
                </div>
                <div style="margin-bottom: 12px; padding: 10px; background: var(--card-bg); border: 1px solid var(--line); border-radius: 4px;">
                    <div style="font-size: 10px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Last Indexed</div>
                    <div id="last-indexed-display" class="mono" style="font-size: 12px; color: var(--accent); font-weight: 600;">—</div>
                </div>
                <button class="small-button" id="btn-autotune-refresh">Refresh Status</button>
            </div>

            <!-- Secrets Ingest -->
            <div class="sidepanel-section">
                <h4>Secrets Ingest</h4>
                <div id="dropzone" class="dropzone">
                    Drop .env / .txt / .md<br>or click to upload
                </div>
                <input type="file" id="file-input" accept=".env,.txt,.md" hidden />
                <div style="margin: 12px 0;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="persist-secrets" style="width: auto;">
                        <span style="text-transform: none;">Persist to defaults.json</span>
                    </label>
                </div>
                <pre id="ingest-out" class="mono" style="margin-top: 12px; padding: 8px; background: var(--code-bg); border-radius: 4px;"></pre>
            </div>
        </div>
    </div>

    <!-- Cards Builder Modal -->
    <div id="cards-builder-modal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 680px; background: var(--panel); border: 1px solid var(--line); border-radius: 8px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <div style="display:flex; align-items:center; justify-content:space-between; padding: 12px 14px; border-bottom: 1px solid var(--line);">
            <div style="font-weight: 700; color: var(--fg);">Cards Builder</div>
            <div>
                <button id="cards-builder-min" class="small-button" style="margin-right:8px;">Minimize</button>
                <button id="cards-builder-close" class="small-button">Close</button>
            </div>
        </div>
        <div style="padding: 14px;">
            <div id="cards-builder-error" style="display:none; background: color-mix(in oklch, var(--err) 8%, var(--bg)); color: var(--err); border:1px solid color-mix(in oklch, var(--err) 30%, var(--bg)); padding:8px; border-radius:4px; margin-bottom:8px; font-size:12px;">Error</div>
            <div style="display:flex; gap: 12px; align-items:center; margin-bottom: 10px;">
                <div id="cards-model-embed" style="font-size:11px; background: var(--card-bg); border:1px solid var(--line); border-radius:12px; padding:4px 8px; color: var(--link);">embed: —</div>
                <div id="cards-model-enrich" style="font-size:11px; background: var(--card-bg); border:1px solid var(--line); border-radius:12px; padding:4px 8px; color: var(--accent);">enrich: —</div>
                <div id="cards-model-rerank" style="font-size:11px; background: var(--card-bg); border:1px solid var(--line); border-radius:12px; padding:4px 8px; color: var(--err);">rerank: —</div>
                <label style="font-size:12px; color: var(--fg-muted); margin-left:auto; display:flex; align-items:center; gap:6px;">
                    <input type="checkbox" id="cards-enrich-toggle" checked /> Enrich code chunks
                </label>
            </div>
            <div style="display:flex; gap: 10px; align-items:center; margin-bottom: 10px;">
                <div id="cards-stage-scan" style="font-size:11px; padding:4px 6px; border-radius:4px; border:1px solid var(--line); color: var(--fg-muted);">scan</div>
                <div id="cards-stage-chunk" style="font-size:11px; padding:4px 6px; border-radius:4px; border:1px solid var(--line); color: var(--fg-muted);">chunk</div>
                <div id="cards-stage-sparse" style="font-size:11px; padding:4px 6px; border-radius:4px; border:1px solid var(--line); color: var(--fg-muted);">sparse</div>
                <div id="cards-stage-dense" style="font-size:11px; padding:4px 6px; border-radius:4px; border:1px solid var(--line); color: var(--fg-muted);">dense</div>
                <div id="cards-stage-summarize" style="font-size:11px; padding:4px 6px; border-radius:4px; border:1px solid var(--line); color: var(--fg-muted);">summarize</div>
                <div id="cards-stage-write" style="font-size:11px; padding:4px 6px; border-radius:4px; border:1px solid var(--line); color: var(--fg-muted);">write</div>
                <div id="cards-stage-finalize" style="font-size:11px; padding:4px 6px; border-radius:4px; border:1px solid var(--line); color: var(--fg-muted);">finalize</div>
            </div>
            <div class="progress" style="height: 12px; background: var(--card-bg); border:1px solid var(--line); border-radius:4px;">
                <div id="cards-main-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--link) 0%, var(--accent) 100%);"></div>
            </div>
            <div id="cards-progress-stats" class="mono" style="font-size:11px; color: var(--fg-muted); margin-top:6px;">0 / 0 (0%)</div>
            <div id="cards-quick-tip" style="margin-top:10px; font-size: 12px; color: var(--fg-muted);">—</div>
            <div style="display:flex; justify-content: flex-end; gap:8px; margin-top: 12px;">
                <button id="cards-view-logs" class="small-button">View Logs</button>
                <button id="cards-cancel" class="small-button" style="background: color-mix(in oklch, var(--err) 10%, var(--bg)); border-color: color-mix(in oklch, var(--err) 30%, var(--bg)); color: var(--err);">Cancel</button>
            </div>
            <pre id="cards-logs-view" style="display:none; margin-top:8px; max-height:200px; overflow:auto; background:var(--card-bg); border:1px solid var(--bg-elev2); border-radius:4px; padding:8px; color:var(--fg-muted); font-size:11px;"></pre>
        </div>


    <datalist id="keywords-list"></datalist>
    <!-- Core utilities (must load first) -->
    <script src="/agro/fetch-shim.js?v=1"></script>
    <script src="/agro/js/core-utils.js?v=1"></script>
    <script src="/agro/api-base-override.js?v=1"></script>

    <!-- UI helpers -->
    <script src="/agro/js/ui-helpers.js"></script>
    <script src="/agro/js/theme.js"></script>

    <!-- Feature modules -->
    <script src="/agro/js/tabs.js"></script>
    <script src="/agro/js/config.js"></script>
    <script src="/agro/js/health.js"></script>
    <script src="/agro/js/git-hooks.js"></script>
    <script src="/agro/js/keywords.js"></script>
    <script src="/agro/js/autotune.js"></script>
    <script src="/agro/js/search.js"></script>
    <script src="/agro/js/editor.js"></script>
    <script src="/agro/js/secrets.js"></script>
    <script src="/agro/js/model_flows.js"></script>
    <script src="/agro/js/index_status.js"></script>
    <script src="/agro/js/mcp_rag.js"></script>
    <script src="/agro/js/mcp_server.js"></script>
    <script src="/agro/js/index_profiles.js"></script>
    <script src="/agro/js/indexing.js"></script>
    <script src="/agro/js/simple_index.js"></script>
    <script src="/agro/js/docker.js"></script>
    <script src="/agro/js/langsmith.js"></script>
    <script src="/agro/js/onboarding.js"></script>

    <!-- Existing modules -->
    <script src="/agro/js/index-display.js"></script>
    <script src="/agro/js/cards.js"></script>
    <script src="/agro/js/cards_builder.js"></script>
    <script src="/agro/js/storage-calculator-template.js"></script>
    <script src="/agro/js/storage-calculator.js"></script>
    <script src="/agro/js/profile_logic.js"></script>
    <script src="/agro/js/tooltips.js"></script>
    <script src="/agro/js/profile_renderer.js"></script>
    <script src="/agro/js/autoprofile_v2.js"></script>
    <script src="/agro/js/cost_logic.js"></script>
    <script src="/agro/js/golden_questions.js"></script>
    <script src="/agro/js/eval_runner.js"></script>
    <script src="/agro/js/chat.js"></script>
    <script src="/agro/js/reranker.js"></script>
    <script src="/agro/js/trace.js"></script>

    <!-- Main app coordination (must load LAST) -->
    <script src="/agro/app.js"></script>

    <!-- Mobile Navigation Menu -->
    <script>
    (function() {
        const toggle = document.getElementById('mobile-nav-toggle');
        const drawer = document.getElementById('mobile-nav-drawer');
        const overlay = document.getElementById('mobile-nav-overlay');

        if (!toggle || !drawer || !overlay) return;

        // Toggle menu open/close
        function toggleMenu(open) {
            if (open) {
                drawer.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent body scroll when menu is open
            } else {
                drawer.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        // Open menu when hamburger is clicked
        toggle.addEventListener('click', function() {
            const isOpen = drawer.classList.contains('active');
            toggleMenu(!isOpen);
        });

        // Close menu when overlay is clicked
        overlay.addEventListener('click', function() {
            toggleMenu(false);
        });

        // Close menu and switch tabs when drawer button is clicked
        const drawerButtons = drawer.querySelectorAll('button[data-tab]');
        drawerButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                // Close the drawer
                toggleMenu(false);

                // Let the existing tabs.js handle the tab switching
                // Just simulate a click on the corresponding desktop tab button
                const tabName = btn.getAttribute('data-tab');
                const desktopBtn = document.querySelector('.tab-bar button[data-tab="' + tabName + '"]');
                if (desktopBtn) {
                    desktopBtn.click();
                }
            });
        });

        // Sync active state from desktop tab-bar to mobile drawer
        // Listen for tab changes and update drawer button states
        const desktopButtons = document.querySelectorAll('.tab-bar button[data-tab]');
        desktopButtons.forEach(function(desktopBtn) {
            desktopBtn.addEventListener('click', function() {
                // Remove active class from all drawer buttons
                drawerButtons.forEach(function(db) {
                    db.classList.remove('active');
                });

                // Add active class to corresponding drawer button
                const tabName = desktopBtn.getAttribute('data-tab');
                const drawerBtn = drawer.querySelector('button[data-tab="' + tabName + '"]');
                if (drawerBtn) {
                    drawerBtn.classList.add('active');
                }
            });
        });
    })();
    </script>
</body>
</html>
