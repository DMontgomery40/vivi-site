<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="robots" content="noindex,nofollow">
  <title>Returns portal</title>
  <link rel="stylesheet" href="/shoes/shoes.css">
  <style>
    /* Prevent iOS zoom on double tap */
    * {
      touch-action: manipulation;
    }

    .order-input-wrapper {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .order-prefix {
      font-size: 16px;
      padding: 12px 0 12px 12px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-right: none;
      border-radius: 8px 0 0 8px;
    }

    .order-number {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-left: none;
      border-radius: 0 8px 8px 0;
      font-size: 16px;
    }

    .input-field {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      width: 100%;
      background: #fff;
      text-align: center;
      letter-spacing: 2px;
      font-family: monospace;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .keypad-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
    }

    .keypad-modal.active {
      display: flex;
    }

    .keypad-content {
      width: 340px;
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .keypad-title {
      margin: 0 0 16px;
      font-size: 18px;
      text-align: center;
    }

    .keypad-display {
      font-size: 24px;
      letter-spacing: 6px;
      text-align: center;
      padding: 16px;
      border: 2px solid #ddd;
      border-radius: 12px;
      margin-bottom: 16px;
      background: #fafafa;
      font-family: monospace;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .keypad-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }

    .keypad-grid button {
      padding: 20px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 10px;
      font-size: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }

    .keypad-grid button:active {
      transform: scale(0.95);
      background: #f0f0f0;
    }

    .keypad-actions {
      display: flex;
      gap: 10px;
    }

    .keypad-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fafafa;
      font-weight: 600;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
  </style>
</head>
<body>
<header class="topbar">
  <div class="brand">VIVIFIED</div>
  <nav>
    <a href="/shoes/index.html">Shop</a>
    <a href="https://www.amazon.com/s?k=sneakers" class="quiet-exit">Support</a>
  </nav>
</header>

<main class="container">
  <div class="form">
    <h2>Track your return</h2>
    <p class="small">Enter your Order # and ZIP to continue.</p>

    <label>Order #</label>
    <div class="order-input-wrapper">
      <div class="order-prefix">ORD-</div>
      <input id="orderDisplay" type="text" class="order-number" readonly placeholder="• • • • • •">
    </div>

    <label>ZIP code</label>
    <input id="zipDisplay" type="text" class="input-field" readonly placeholder="• • • • •">

    <button class="primary" id="go">Continue</button>
    <p id="status" class="small"></p>
  </div>
</main>

<!-- Order Number Keypad Modal -->
<div id="orderModal" class="keypad-modal">
  <div class="keypad-content">
    <h3 class="keypad-title">Enter Order Number</h3>
    <div id="orderKeypadDisplay" class="keypad-display">• • • • • •</div>
    <div class="keypad-grid">
      <button data-key="1" data-type="order">1</button>
      <button data-key="2" data-type="order">2</button>
      <button data-key="3" data-type="order">3</button>
      <button data-key="4" data-type="order">4</button>
      <button data-key="5" data-type="order">5</button>
      <button data-key="6" data-type="order">6</button>
      <button data-key="7" data-type="order">7</button>
      <button data-key="8" data-type="order">8</button>
      <button data-key="9" data-type="order">9</button>
      <button data-key="del" data-type="order">Del</button>
      <button data-key="0" data-type="order">0</button>
      <button data-key="ok" data-type="order">OK</button>
    </div>
    <div class="keypad-actions">
      <button id="orderClear">Clear</button>
      <button id="orderCancel">Cancel</button>
    </div>
  </div>
</div>

<!-- ZIP Keypad Modal -->
<div id="zipModal" class="keypad-modal">
  <div class="keypad-content">
    <h3 class="keypad-title">Enter ZIP Code</h3>
    <div id="zipKeypadDisplay" class="keypad-display">• • • • •</div>
    <div class="keypad-grid">
      <button data-key="1" data-type="zip">1</button>
      <button data-key="2" data-type="zip">2</button>
      <button data-key="3" data-type="zip">3</button>
      <button data-key="4" data-type="zip">4</button>
      <button data-key="5" data-type="zip">5</button>
      <button data-key="6" data-type="zip">6</button>
      <button data-key="7" data-type="zip">7</button>
      <button data-key="8" data-type="zip">8</button>
      <button data-key="9" data-type="zip">9</button>
      <button data-key="del" data-type="zip">Del</button>
      <button data-key="0" data-type="zip">0</button>
      <button data-key="ok" data-type="zip">OK</button>
    </div>
    <div class="keypad-actions">
      <button id="zipClear">Clear</button>
      <button id="zipCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
// Prevent double tap zoom on iOS
document.addEventListener('touchstart', function(e) {
  if (e.touches.length > 1) {
    e.preventDefault();
  }
});

let orderInput = "";
let zipInput = "";

// Update displays
function updateOrderDisplay() {
  const display = document.getElementById('orderKeypadDisplay');
  const field = document.getElementById('orderDisplay');
  const masked = orderInput.padEnd(6, '•').split('').join(' ');
  display.textContent = masked;
  field.value = orderInput || "";
  field.placeholder = orderInput ? "" : "• • • • • •";
}

function updateZipDisplay() {
  const display = document.getElementById('zipKeypadDisplay');
  const field = document.getElementById('zipDisplay');
  const masked = zipInput.padEnd(5, '•').split('').join(' ');
  display.textContent = masked;
  field.value = zipInput || "";
  field.placeholder = zipInput ? "" : "• • • • •";
}

// Handle keypad input
function handleKeyPress(key, type) {
  if (type === 'order') {
    if (key === 'del') {
      orderInput = orderInput.slice(0, -1);
      updateOrderDisplay();
    } else if (key === 'ok') {
      if (orderInput.length === 6) {
        document.getElementById('orderModal').classList.remove('active');
      }
    } else if (/\d/.test(key) && orderInput.length < 6) {
      orderInput += key;
      updateOrderDisplay();
    }
  } else if (type === 'zip') {
    if (key === 'del') {
      zipInput = zipInput.slice(0, -1);
      updateZipDisplay();
    } else if (key === 'ok') {
      if (zipInput.length === 5) {
        document.getElementById('zipModal').classList.remove('active');
      }
    } else if (/\d/.test(key) && zipInput.length < 5) {
      zipInput += key;
      updateZipDisplay();
    }
  }
}

// Open modals
document.getElementById('orderDisplay').addEventListener('click', () => {
  updateOrderDisplay();
  document.getElementById('orderModal').classList.add('active');
});

document.getElementById('zipDisplay').addEventListener('click', () => {
  updateZipDisplay();
  document.getElementById('zipModal').classList.add('active');
});

// Keypad button handlers - prevent zoom
document.querySelectorAll('.keypad-grid button').forEach(btn => {
  btn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const key = btn.dataset.key;
    const type = btn.dataset.type;
    handleKeyPress(key, type);
  });

  btn.addEventListener('click', (e) => {
    e.preventDefault();
    const key = btn.dataset.key;
    const type = btn.dataset.type;
    handleKeyPress(key, type);
  });
});

// Clear and Cancel buttons
document.getElementById('orderClear').addEventListener('click', () => {
  orderInput = "";
  updateOrderDisplay();
});

document.getElementById('orderCancel').addEventListener('click', () => {
  document.getElementById('orderModal').classList.remove('active');
});

document.getElementById('zipClear').addEventListener('click', () => {
  zipInput = "";
  updateZipDisplay();
});

document.getElementById('zipCancel').addEventListener('click', () => {
  document.getElementById('zipModal').classList.remove('active');
});

// Close modals on background click
document.getElementById('orderModal').addEventListener('click', (e) => {
  if (e.target.id === 'orderModal') {
    document.getElementById('orderModal').classList.remove('active');
  }
});

document.getElementById('zipModal').addEventListener('click', (e) => {
  if (e.target.id === 'zipModal') {
    document.getElementById('zipModal').classList.remove('active');
  }
});

// Login function
async function login(order, zip) {
  const r = await fetch('/.netlify/functions/login', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ order: 'ORD-' + order, zip })
  });
  if (!r.ok) {
    return { ok: false, m: 'Service temporarily unavailable. Try again later.' };
  }
  const data = await r.json().catch(()=>({}));
  return data;
}

// Continue button handler
document.getElementById('go').addEventListener('click', async () => {
  const out = document.getElementById('status');

  if (orderInput.length !== 6 || zipInput.length !== 5) {
    out.textContent = 'Please enter complete order # and ZIP';
    return;
  }

  out.textContent = 'Checking…';
  const res = await login(orderInput, zipInput);
  if (res && res.ok) {
    // Store clear permission in sessionStorage
    if (res.canClear) {
      sessionStorage.setItem('canClear', 'true');
    }
    window.location.href = '/shoes/returns-portal.html';
  } else {
    out.textContent = 'Order not found. Please contact support later.';
  }
});
</script>
</body>
</html>